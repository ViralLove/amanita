# üîÑ –°–∏—Å—Ç–µ–º–∞ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Amanita

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Amanita –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
1. **–ë–ª–æ–∫—á–µ–π–Ω** - –±–∞–∑–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (ID, seller, IPFS CID, active status)
2. **IPFS/Arweave** - –ø–æ–ª–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ

–°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–±–µ—Å—à–æ–≤–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é** –º–µ–∂–¥—É –±–ª–æ–∫—á–µ–π–Ω–æ–º –∏ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—è –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ü—Ä–∏–Ω—Ü–∏–ø—ã

### 1.1 –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –î–∞–Ω–Ω—ã—Ö
- **–ë–ª–æ–∫—á–µ–π–Ω**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **IPFS/Arweave**: –ü–æ–ª–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (–æ–ø–∏—Å–∞–Ω–∏—è, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ü–µ–Ω—ã)
- **–ö—ç—à**: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1.2 –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –û–±—Ä–∞–±–æ—Ç–∫–∞
- **Lazy Loading**: –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- **Batch Processing**: –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **Fallback Mechanisms**: Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 1.3 –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –ö–∞–∂–¥–æ–º –£—Ä–æ–≤–Ω–µ
- **Blockchain Validation**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
- **IPFS Validation**: –í–∞–ª–∏–¥–∞—Ü–∏—è CID –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON
- **Model Validation**: –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ ValidationFactory

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞

### 2.1 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –°–∏—Å—Ç–µ–º—ã

```
BlockchainService (–ë–∞–∑–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
    ‚Üì
ProductRegistryService (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è)
    ‚Üì
ProductStorageService (IPFS/Arweave)
    ‚Üì
ProductMetadataService (–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)
    ‚Üì
Product Model (–§–∏–Ω–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å)
```

### 2.2 –ü–æ—Ç–æ–∫ –î–∞–Ω–Ω—ã—Ö

```
1. Blockchain Query (get_all_products)
   ‚Üì
2. Raw Blockchain Data (id, seller, ipfsCID, active)
   ‚Üì
3. IPFS Download (download_json)
   ‚Üì
4. JSON Deserialization (process_product_metadata)
   ‚Üì
5. Product Model Assembly
   ‚Üì
6. Caching & Return
```

## üîß –ö–ª—é—á–µ–≤—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 3.1 BlockchainService - –ò—Å—Ç–æ—á–Ω–∏–∫ –ë–∞–∑–æ–≤—ã—Ö –î–∞–Ω–Ω—ã—Ö

```python
class BlockchainService:
    def get_all_products(self) -> List[dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
            product_ids = self._call_contract_read_function(
                "ProductRegistry",
                "getAllActiveProductIds",
                []
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
            products = []
            for product_id in product_ids:
                product = self._call_contract_read_function(
                    "ProductRegistry",
                    "getProduct",
                    None,
                    product_id
                )
                if product:
                    products.append(product)
            
            return products
            
        except Exception as e:
            logger.error(f"Error getting products: {e}")
            return []
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞:**
```python
# ProductRegistry.Product struct
product_data = (
    id,           # uint256 - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    seller,       # address - –∞–¥—Ä–µ—Å –ø—Ä–æ–¥–∞–≤—Ü–∞
    ipfsCID,     # string - CID –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ IPFS
    active        # bool - —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
)
```

### 3.2 ProductStorageService - –†–∞–±–æ—Ç–∞ —Å IPFS/Arweave

```python
class ProductStorageService:
    async def download_json(self, cid: str) -> Optional[Dict[str, Any]]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç JSON –∏–∑ IPFS/Arweave"""
        try:
            if not self.validate_ipfs_cid(cid):
                self.logger.warning(f"Invalid CID format: {cid}")
                return None
                
            return await self.ipfs.download_json_async(cid)
            
        except Exception as e:
            self.logger.error(f"Error downloading JSON from IPFS: {e}")
            return None
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
- **Pinata**: –û—Å–Ω–æ–≤–Ω–æ–π IPFS –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- **Arweave**: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- **IPFSFactory**: –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º

### 3.3 ProductMetadataService - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

```python
class ProductMetadataService:
    def process_product_metadata(self, metadata: Dict[str, Any]) -> Optional[Product]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ IPFS"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ ValidationFactory
            validator = ValidationFactory.get_product_validator()
            validation_result = validator.validate(metadata)
            
            if not validation_result.is_valid:
                self.logger.error(f"‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø—Ä–æ—à–ª–∞: {validation_result.error_message}")
                return None
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
            title = metadata.get('title', '')
            product_id = metadata.get('id', '')
            alias = metadata.get('id', '')
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            organic_components = []
            for component_data in metadata.get('organic_components', []):
                component = OrganicComponent.from_dict(component_data)
                organic_components.append(component)
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã
            prices = []
            for price_data in metadata.get('prices', []):
                price = PriceInfo.from_dict(price_data)
                prices.append(price)
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Product
            product = Product(
                id=product_id,
                alias=alias,
                title=title,
                organic_components=organic_components,
                prices=prices,
                # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
            )
            
            return product
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: {e}")
            return None
```

### 3.4 ProductRegistryService - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –ü—Ä–æ—Ü–µ—Å—Å–∞

```python
class ProductRegistryService:
    async def _deserialize_product(self, product_data: tuple) -> Optional[Product]:
        """–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç –∏–∑ –∫–æ—Ä—Ç–µ–∂–∞ –±–ª–æ–∫—á–µ–π–Ω–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö IPFS"""
        try:
            if not hasattr(product_data, '__getitem__') or len(product_data) < 4:
                self.logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ product_data: {product_data}")
                return None

            product_id = product_data[0]  # –ë–ª–æ–∫—á–µ–π–Ω ID
            ipfs_cid = product_data[2]   # IPFS CID
            is_active = bool(product_data[3])  # –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ IPFS
            metadata = self.storage_service.download_json(ipfs_cid)
            if not metadata:
                self.logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ {product_id}")
                return None

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
            product = self.metadata_service.process_product_metadata(metadata)
            if product:
                # –î–æ–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
                product.id = product_id
                product.cid = ipfs_cid
                product.is_active = is_active
                product.status = 1 if is_active else 0
                
            return product
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞: {e}")
            return None
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –°–±–æ—Ä–∫–∏ –ü—Ä–æ–¥—É–∫—Ç–∞

### 4.1 –ü–æ–ª—É—á–µ–Ω–∏–µ –ö–∞—Ç–∞–ª–æ–≥–∞ (get_all_products)

```python
async def get_all_products(self) -> List[Product]:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞
        catalog_version = self.blockchain_service.get_catalog_version()
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cached_catalog = self.cache_service.get_cached_item("catalog", "catalog")
        if cached_catalog and cached_catalog.get("version") == catalog_version:
            return cached_catalog.get('products', [])
        
        # 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
        products_data = self.blockchain_service.get_all_products()
        products = []
        
        # 4. –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç
        for product_data in products_data:
            product = await self._deserialize_product(product_data)
            if product:
                products.append(product)
        
        # 5. –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
        self.cache_service.set_cached_item("catalog", {
            "version": catalog_version,
            "products": products
        }, "catalog")
        
        return products
        
    except Exception as e:
        self.logger.error(f"Error getting all products: {e}")
        return []
```

### 4.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –û—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ü—Ä–æ–¥—É–∫—Ç–∞ (get_product)

```python
async def get_product(self, product_id: Union[str, int]) -> Optional[Product]:
    """–ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç –ø–æ ID"""
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cached_product = self.cache_service.get_cached_item("product", str(product_id))
        if cached_product:
            return cached_product
        
        # 2. –ü–æ–ª—É—á–∞–µ–º –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
        product_data = self.blockchain_service.get_product(product_id)
        if not product_data:
            return None
        
        # 3. –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–¥—É–∫—Ç
        product = await self._deserialize_product(product_data)
        
        # 4. –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if product:
            self.cache_service.set_cached_item("product", product, str(product_id))
        
        return product
        
    except Exception as e:
        self.logger.error(f"Error getting product {product_id}: {e}")
        return None
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö

### 5.1 –ë–ª–æ–∫—á–µ–π–Ω –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (ProductRegistry.sol)

```solidity
struct Product {
    uint256 id;          // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞
    address seller;      // –ü—Ä–æ–¥–∞–≤–µ—Ü (–∞–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏)
    string ipfsCID;      // –°—Å—ã–ª–∫–∞ –Ω–∞ JSON-–æ–ø–∏—Å–∞–Ω–∏–µ (IPFS CID)
    bool active;         // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä
}
```

### 5.2 IPFS JSON –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```json
{
    "id": "product_001",
    "title": "Amanita Muscaria Powder",
    "organic_components": [
        {
            "biounit_id": "amanita_muscaria",
            "description_cid": "QmDescriptionHash...",
            "proportion": "100%"
        }
    ],
    "cover_image": "QmImageHash...",
    "categories": ["mushroom", "powder"],
    "forms": ["powder"],
    "species": "Amanita muscaria",
    "prices": [
        {
            "price": "30.00",
            "currency": "EUR",
            "weight": "100",
            "weight_unit": "g",
            "form": "powder"
        }
    ],
    "created_at": "2024-01-01T00:00:00Z"
}
```

### 5.3 –§–∏–Ω–∞–ª—å–Ω–∞—è –ú–æ–¥–µ–ª—å Product

```python
@dataclass
class Product:
    id: Union[str, int]           # –ë–ª–æ–∫—á–µ–π–Ω ID
    alias: str                     # –ë–∏–∑–Ω–µ—Å-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    status: int                    # –°—Ç–∞—Ç—É—Å (0/1)
    cid: str                       # IPFS CID
    title: str                     # –ù–∞–∑–≤–∞–Ω–∏–µ
    organic_components: List[OrganicComponent]  # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    cover_image_url: Optional[str] # URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    categories: List[str]          # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    forms: List[str]               # –§–æ—Ä–º—ã
    species: str                   # –í–∏–¥
    prices: List[PriceInfo]        # –¶–µ–Ω—ã
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ API

### 6.1 Bot Handler (Telegram)

```python
@router.callback_query(F.data == "menu:catalog")
async def show_catalog(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —á–µ—Ä–µ–∑ ProductRegistryService (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
        products = product_registry_service.get_all_products()
        
        if not products:
            await callback.message.answer(loc.t("catalog.empty"))
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        for product in products:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞
            product_text = format_product_description(product, lang)
            await callback.message.answer(product_text)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–∞—Ç–∞–ª–æ–≥–∞: {e}")
        await callback.message.answer(loc.t("catalog.error"))
```

### 6.2 API Endpoints (FastAPI)

```python
# TODO: –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞
@router.get("/catalog", response_model=List[ProductResponse])
async def get_catalog(
    registry_service: ProductRegistryService = Depends(get_product_registry_service)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"""
    products = await registry_service.get_all_products()
    return [ProductResponse.from_product(product) for product in products]

@router.get("/products/{product_id}", response_model=ProductResponse)
async def get_product(
    product_id: str,
    registry_service: ProductRegistryService = Depends(get_product_registry_service)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ ID"""
    product = await registry_service.get_product(product_id)
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    return ProductResponse.from_product(product)
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –°–∏—Å—Ç–µ–º—ã

### 7.1 Mock –°–∏—Å—Ç–µ–º–∞

```python
@pytest.fixture(scope="function")
def mock_ipfs_storage():
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–∫ –¥–ª—è IPFS/Arweave storage"""
    class MockIPFSStorage:
        def __init__(self):
            self._storage = {}  # CID -> data mapping
            self._counter = 0   # –°—á–µ—Ç—á–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö CID
        
        def download_json(self, cid: str) -> Optional[Dict]:
            return self._storage.get(cid)
        
        def upload_json(self, data: Dict) -> str:
            cid = f"QmMockCID{self._counter:06d}"
            self._storage[cid] = data
            self._counter += 1
            return cid
    
    return MockIPFSStorage()
```

### 7.2 –¢–µ—Å—Ç–æ–≤—ã–µ –§–∏–∫—Å—Ç—É—Ä—ã

```python
@pytest.fixture(scope="function")
def mock_blockchain_service():
    """Mock –¥–ª—è BlockchainService"""
    class MockBlockchainService:
        def get_catalog_version(self):
            return 1
        
        def get_all_products(self):
            return [
                (1, "0x123", "QmCID1", True),
                (2, "0x456", "QmCID2", True),
                (3, "0x789", "QmCID3", True)
            ]
    
    return MockBlockchainService()
```

## üîç –û—Ç–ª–∞–¥–∫–∞ –∏ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 8.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ü—Ä–æ—Ü–µ—Å—Å–∞

```python
def _deserialize_product(self, product_data: tuple) -> Optional[Product]:
    """–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ–¥—É–∫—Ç —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    try:
        self.logger.info(f"üîç –ù–∞—á–∏–Ω–∞–µ–º –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞: {product_data}")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
        product_id = product_data[0]
        ipfs_cid = product_data[2]
        is_active = bool(product_data[3])
        
        self.logger.info(f"üîç –î–∞–Ω–Ω—ã–µ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞: ID={product_id}, CID={ipfs_cid}, Active={is_active}")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ IPFS
        self.logger.info(f"üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ IPFS: {ipfs_cid}")
        metadata = self.storage_service.download_json(ipfs_cid)
        
        if not metadata:
            self.logger.warning(f"‚ö†Ô∏è –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è CID: {ipfs_cid}")
            return None
        
        self.logger.info(f"üîç –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {len(metadata)} –ø–æ–ª–µ–π")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        product = self.metadata_service.process_product_metadata(metadata)
        
        if product:
            self.logger.info(f"‚úÖ –ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω: {product.id}")
        else:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ {product_id}")
        
        return product
        
    except Exception as e:
        self.logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        return None
```

### 8.2 –ú–µ—Ç—Ä–∏–∫–∏ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
import time

async def get_all_products(self) -> List[Product]:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    start_time = time.time()
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache_start = time.time()
        cached_catalog = self.cache_service.get_cached_item("catalog", "catalog")
        cache_time = time.time() - cache_start
        
        if cached_catalog and self._is_cache_valid(cached_catalog):
            self.logger.info(f"‚ö° –ö—ç—à –Ω–∞–π–¥–µ–Ω –∑–∞ {cache_time:.3f}s")
            return cached_catalog.get('products', [])
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞
        blockchain_start = time.time()
        products_data = self.blockchain_service.get_all_products()
        blockchain_time = time.time() - blockchain_start
        
        # –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
        deserialize_start = time.time()
        products = []
        for product_data in products_data:
            product = await self._deserialize_product(product_data)
            if product:
                products.append(product)
        deserialize_time = time.time() - deserialize_start
        
        total_time = time.time() - start_time
        
        self.logger.info(f"üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:")
        self.logger.info(f"  - –ö—ç—à: {cache_time:.3f}s")
        self.logger.info(f"  - –ë–ª–æ–∫—á–µ–π–Ω: {blockchain_time:.3f}s")
        self.logger.info(f"  - –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: {deserialize_time:.3f}s")
        self.logger.info(f"  - –û–±—â–µ–µ –≤—Ä–µ–º—è: {total_time:.3f}s")
        self.logger.info(f"  - –ü—Ä–æ–¥—É–∫—Ç–æ–≤: {len(products)}")
        
        return products
        
    except Exception as e:
        self.logger.error(f"Error getting all products: {e}")
        return []
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### 9.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –•—Ä–∞–Ω–∏–ª–∏—â

```python
# .env —Ñ–∞–π–ª
STORAGE_TYPE=pinata  # –∏–ª–∏ arweave
PINATA_API_KEY=your_pinata_key
PINATA_SECRET_KEY=your_pinata_secret
ARWEAVE_PRIVATE_KEY=your_arweave_key

# IPFSFactory –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
storage_service = IPFSFactory().get_storage()
```

### 9.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞ –≤ ProductCacheService
CACHE_TTL = 3600  # 1 —á–∞—Å
CATALOG_CACHE_TTL = 1800  # 30 –º–∏–Ω—É—Ç –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
PRODUCT_CACHE_TTL = 7200  # 2 —á–∞—Å–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
```

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 10.1 Batch Processing

```python
async def _deserialize_products_batch(self, products_data: List[tuple]) -> List[Product]:
    """–ü–∞–∫–µ—Ç–Ω–∞—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"""
    tasks = [self._deserialize_product(data) for data in products_data]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    products = []
    for i, result in enumerate(results):
        if isinstance(result, Exception):
            self.logger.error(f"–û—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ {i}: {result}")
        elif result:
            products.append(result)
    
    return products
```

### 10.2 Lazy Loading

```python
class Product:
    def __init__(self, **kwargs):
        self._description = None
        self._images = None
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    
    @property
    def description(self) -> Optional[Description]:
        """Lazy loading –æ–ø–∏—Å–∞–Ω–∏—è"""
        if self._description is None and self.description_cid:
            self._description = self._load_description()
        return self._description
    
    def _load_description(self) -> Optional[Description]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ CID"""
        try:
            storage_service = ProductStorageService()
            description_data = storage_service.download_json(self.description_cid)
            if description_data:
                return Description.from_dict(description_data)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è: {e}")
        return None
```

## üîÆ –ë—É–¥—É—â–∏–µ –£–ª—É—á—à–µ–Ω–∏—è

### 11.1 –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –§—É–Ω–∫—Ü–∏–∏
- [ ] **Streaming API** –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤
- [ ] **GraphQL** –¥–ª—è –≥–∏–±–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] **Real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º
- [ ] **Distributed caching** —á–µ—Ä–µ–∑ Redis Cluster

### 11.2 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- [ ] **Connection pooling** –¥–ª—è IPFS gateways
- [ ] **Circuit breaker** –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
- [ ] **Rate limiting** –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
- [ ] **Metrics collection** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Amanita –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–≤—ã—Å–æ–∫–æ–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

1. **üèóÔ∏è –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
2. **‚ö° –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –±–ª–∞–≥–æ–¥–∞—Ä—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é –∏ batch processing
3. **üîí –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** —Å fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
4. **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
5. **üß™ –ü–æ–ª–Ω–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** —Å comprehensive mock —Å–∏—Å—Ç–µ–º–æ–π
6. **üîÑ –ë–µ—Å—à–æ–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** –º–µ–∂–¥—É –±–ª–æ–∫—á–µ–π–Ω–æ–º –∏ IPFS

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Å–±–æ—Ä–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤** –∏–∑ –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö, **–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ **–Ω–∞–¥–µ–∂–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ.

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $(date)*
*–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: 1.0.0*
*–ê–≤—Ç–æ—Ä: Amanita Team*
