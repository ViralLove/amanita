# Epic: E-commerce в Telegram боте - Моноселлер система

## Epic: EPIC-ECO-001 - Telegram E-commerce Integration
**Epic ID:** EPIC-ECO-001  
**Epic Description:** Создание полноценной первой селлеро ноды системы e-commerce в Telegram боте с интеграцией WooCommerce через Amanita плагин

---

## User Story: Каталог товаров в Telegram боте

### US-ECO-001: Как покупатель, я хочу просматривать каталог товаров в Telegram боте, чтобы выбирать товары для покупки

**Story ID:** US-ECO-001  
**Priority:** Critical (MVP)  
**Story Points:** 8  
**Sprint:** Sprint 1  
**Assignee:** Frontend Team  
**QA:** QA Team  

### Описание
Покупатель должен иметь возможность просматривать каталог товаров из WooCommerce через API Amanita плагина в удобном интерфейсе Telegram бота. Каталог должен отображаться красиво и удобно для навигации. Он становится доступным после прохождения onbparding процесса результатом которого у пользователя появляется некастодиальный адрес (=user account).

### Критерии приемки (Acceptance Criteria)

#### AC-ECO-001.1: Отображение каталога товаров
- **Given** в WooCommerce есть товары, управляемые через Amanita плагин
- **When** покупатель открывает каталог в боте но не ранее чем пройдет onboarding с обязательным использованием Invite Code
- **Then** отображается список товаров с изображениями, названиями и ценами из WooCommerce
- **And** товары сгруппированы по категориям WooCommerce
- **And** поддерживается пагинация (Load more... как в Instagram ленте) для больших каталогов

#### AC-ECO-001.2: Детальная информация о товаре
- **Given** покупатель выбирает товар из каталога
- **When** покупатель просматривает детали товара
- **Then** отображается полная информация из WooCommerce: описание, галерея изображений, цены, характеристики
- **And** показывается информация о продавце из WooCommerce
- **And** отображается статус товара в блокчейне (через Amanita плагин)

#### AC-ECO-001.3: Фильтрация и поиск
- **Given** в каталоге много товаров
- **When** покупатель ищет товары
- **Then** работает поиск по названию и описанию через WooCommerce API
- **And** доступна фильтрация по категориям WooCommerce
- **And** доступна сортировка по цене и популярности

---

## User Story: Процесс покупки в Telegram боте

### US-ECO-002: Как покупатель, я хочу совершать покупки товаров через Telegram бот, чтобы получать товары без необходимости переходить на внешние сайты

**Story ID:** US-ECO-002  
**Priority:** Critical (MVP)  
**Story Points:** 13  
**Sprint:** Sprint 2  
**Assignee:** Full Stack Team  
**QA:** QA Team  

### Описание
Покупатель должен иметь возможность совершать покупки товаров прямо в Telegram боте, используя стандартные методы оплаты WooCommerce (manual payment). Процесс должен быть простым и интуитивным, с интеграцией через WooCommerce API.

### Критерии приемки (Acceptance Criteria)

#### AC-ECO-002.1: Добавление товаров в корзину
- **Given** покупатель просматривает товар из WooCommerce
- **When** покупатель нажимает "Добавить в корзину"
- **Then** товар добавляется в корзину бота
- **And** отображается количество товаров в корзине
- **And** сохраняется выбор между сессиями

#### AC-ECO-002.2: Управление корзиной
- **Given** в корзине есть товары
- **When** покупатель открывает корзину
- **Then** отображается список товаров с возможностью изменения количества
- **And** показывается общая стоимость в выбранной валюте
- **And** можно удалить товары из корзины

#### AC-ECO-002.3: Оформление заказа
- **Given** покупатель готов оформить заказ
- **When** покупатель нажимает "Оформить заказ"
- **Then** система запрашивает контактную информацию покупателя
- **And** предлагает доступные методы оплаты (manual payment)
- **And** создает заказ в WooCommerce через Amanita плагин API

#### AC-ECO-002.4: Выбор метода оплаты
- **Given** покупатель оформляет заказ
- **When** покупатель выбирает метод оплаты
- **Then** доступны только manual payment методы: перевод на счет или крипто адрес
- **And** отображается информация для оплаты (реквизиты/адрес)
- **And** заказ создается в WooCommerce со статусом "pending"

#### AC-ECO-002.5: Подтверждение заказа
- **Given** заказ создан в WooCommerce
- **When** система завершает создание заказа
- **Then** покупатель получает подтверждение с деталями заказа из WooCommerce
- **And** заказ отображается в истории покупок
- **And** продавец получает уведомление о новом заказе в WooCommerce

---

## User Story: Интеграция с WooCommerce через Amanita плагин

### US-ECO-003: Как система, я хочу синхронизировать заказы с WooCommerce через Amanita плагин, чтобы обеспечить полный цикл e-commerce

**Story ID:** US-ECO-003  
**Priority:** Critical (MVP)  
**Story Points:** 10  
**Sprint:** Sprint 3  
**Assignee:** Backend Team  
**QA:** QA Team  

### Описание
Система должна интегрироваться с WooCommerce через Amanita плагин для синхронизации заказов, управления товарами и обеспечения полного цикла e-commerce. Telegram бот выступает как дополнительный UI для WooCommerce.

### Критерии приемки (Acceptance Criteria)

#### AC-ECO-003.1: Синхронизация заказов с WooCommerce
- **Given** заказ создан в Telegram боте
- **When** система синхронизирует заказ через Amanita плагин API
- **Then** заказ создается в WooCommerce через Amanita плагин
- **And** Amanita плагин записывает транзакцию в блокчейн для трассировки
- **And** статус заказа синхронизируется между ботом и WooCommerce

#### AC-ECO-003.2: Управление товарами через WooCommerce
- **Given** продавец управляет товарами в WooCommerce
- **When** товары изменяются
- **Then** изменения доступны в Telegram боте через Amanita плагин API
- **And** каталог в Telegram боте обновляется автоматически
- **And** поддерживается актуальность данных

#### AC-ECO-003.3: Обработка статусов заказов через webhooks
- **Given** заказ обрабатывается в WooCommerce
- **When** статус заказа изменяется
- **Then** Amanita плагин отправляет webhook в Python приложение
- **And** Python приложение обновляет статус в блокчейне
- **And** покупатель получает уведомление в Telegram

---

## User Story: История покупок и управление заказами

### US-ECO-004: Как покупатель, я хочу просматривать историю покупок и управлять заказами, чтобы отслеживать свои покупки

**Story ID:** US-ECO-004  
**Priority:** High (MVP)  
**Story Points:** 6  
**Sprint:** Sprint 3  
**Assignee:** Frontend Team  
**QA:** QA Team  

### Описание
Покупатель должен иметь возможность просматривать историю покупок из WooCommerce, отслеживать статус заказов и получать уведомления об изменениях.

### Критерии приемки (Acceptance Criteria)

#### AC-ECO-004.1: История покупок
- **Given** покупатель совершил покупки через бота
- **When** покупатель открывает историю покупок
- **Then** отображается список всех заказов из WooCommerce с датами и статусами
- **And** можно просмотреть детали каждого заказа
- **And** поддерживается пагинация для больших списков

#### AC-ECO-004.2: Отслеживание статуса заказа
- **Given** заказ находится в обработке в WooCommerce
- **When** покупатель просматривает заказ
- **Then** отображается текущий статус заказа из WooCommerce
- **And** показывается история изменений статуса
- **And** можно связаться с продавцом при необходимости

#### AC-ECO-004.3: Уведомления о заказах
- **Given** статус заказа изменился в WooCommerce
- **When** система обрабатывает изменение через webhook
- **Then** покупатель получает уведомление в Telegram
- **And** уведомление содержит актуальную информацию
- **And** можно быстро перейти к заказу из уведомления

---

## User Story: Webhook интеграция для уведомлений

### US-ECO-005: Как система, я хочу получать webhook уведомления от WooCommerce через Amanita плагин, чтобы синхронизировать статусы заказов

**Story ID:** US-ECO-005  
**Priority:** Critical (MVP)  
**Story Points:** 8  
**Sprint:** Sprint 3  
**Assignee:** Backend Team  
**QA:** QA Team  

### Описание
Система должна получать webhook уведомления от WooCommerce через Amanita плагин для синхронизации статусов заказов и отправки уведомлений в Telegram.

### Критерии приемки (Acceptance Criteria)

#### AC-ECO-005.1: Webhook обработка статусов заказов
- **Given** статус заказа изменяется в WooCommerce
- **When** Amanita плагин отправляет webhook
- **Then** Python приложение получает уведомление
- **And** статус заказа обновляется в блокчейне
- **And** покупатель получает уведомление в Telegram

#### AC-ECO-005.2: Уведомления в Telegram
- **Given** webhook получен от WooCommerce
- **When** система обрабатывает уведомление
- **Then** покупатель получает уведомление в Telegram
- **And** уведомление содержит актуальный статус заказа
- **And** можно перейти к деталям заказа из уведомления

#### AC-ECO-005.3: Обработка ошибок webhook
- **Given** webhook не может быть обработан
- **When** система получает ошибку
- **Then** ошибка логируется для диагностики
- **And** система пытается повторить обработку
- **And** администратор получает уведомление о проблеме

---

## Технические задачи (MVP для моноселлер системы)

### TASK-ECO-001: Создание FSM для каталога товаров
**Task ID:** TASK-ECO-001  
**Story:** US-ECO-001  
**Priority:** Critical (MVP)  
**Estimated Hours:** 8  
**Dependencies:** None  

**Описание:**  
Создать FSM (Finite State Machine) для навигации по каталогу товаров в Telegram боте. Реализовать отображение товаров из WooCommerce через Amanita плагин API.

**Технические инструкции:**
- Создать `catalog_fsm.py` с состояниями для каталога
- Реализовать отображение товаров с inline клавиатурами
- Добавить пагинацию для больших каталогов
- Интегрировать с Amanita плагином API для получения товаров из WooCommerce
- Добавить кэширование каталога для производительности

**Интеграция с Amanita плагином:**
- Получение товаров из WooCommerce через API плагина
- Отображение информации о продавце из WooCommerce
- Показ статуса товара в блокчейне (через плагин)

### TASK-ECO-002: Создание FSM для процесса покупки
**Task ID:** TASK-ECO-002  
**Story:** US-ECO-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 12  
**Dependencies:** TASK-ECO-001  

**Описание:**  
Создать FSM для процесса покупки товаров, включая корзину, оформление заказа и выбор метода оплаты через WooCommerce.

**Технические инструкции:**
- Создать `purchase_fsm.py` с состояниями покупки
- Реализовать корзину с сохранением в базе данных бота
- Добавить сбор контактной информации покупателя
- Интегрировать с Amanita плагином API для создания заказов в WooCommerce
- Создать систему уведомлений о статусе заказа
- Поддержка manual payment методов (перевод на счет/крипто адрес)

**Интеграция с Amanita плагином:**
- Создание заказов в WooCommerce через API плагина
- Синхронизация статусов заказов
- Передача информации о покупателе в WooCommerce

### TASK-ECO-003: API клиент для интеграции с Amanita плагином
**Task ID:** TASK-ECO-003  
**Story:** US-ECO-003  
**Priority:** Critical (MVP)  
**Estimated Hours:** 10  
**Dependencies:** TASK-ECO-002  

**Описание:**  
Создать API клиент для интеграции с Amanita плагином WooCommerce. Обеспечить синхронизацию заказов и управление товарами.

**Технические инструкции:**
- Создать `amanita_woocommerce_client.py` для работы с API плагина
- Реализовать методы для получения каталога товаров
- Реализовать методы для создания и управления заказами
- Добавить валидацию данных заказов
- Реализовать обработку ошибок и retry логику
- Добавить кэширование для производительности

**Модели данных:**
```python
class WooCommerceProduct(BaseModel):
    id: int
    name: str
    description: str
    price: str
    images: List[str]
    categories: List[str]
    seller_info: Optional[dict]
    blockchain_status: Optional[str]

class WooCommerceOrder(BaseModel):
    id: int
    customer_info: dict
    items: List[dict]
    total_amount: str
    status: str
    payment_method: str
    blockchain_tx_hash: Optional[str]
    created_at: datetime
    updated_at: datetime
```

### TASK-ECO-004: Создание FSM для истории покупок
**Task ID:** TASK-ECO-004  
**Story:** US-ECO-004  
**Priority:** High (MVP)  
**Estimated Hours:** 6  
**Dependencies:** TASK-ECO-003  

**Описание:**  
Создать FSM для просмотра истории покупок и управления заказами из WooCommerce. Реализовать отслеживание статусов и уведомления.

**Технические инструкции:**
- Создать `orders_fsm.py` с состояниями для заказов
- Реализовать отображение истории покупок из WooCommerce
- Добавить детальный просмотр заказов
- Интегрировать с системой уведомлений
- Добавить возможность связи с продавцом

### TASK-ECO-005: Webhook обработчик для WooCommerce
**Task ID:** TASK-ECO-005  
**Story:** US-ECO-005  
**Priority:** Critical (MVP)  
**Estimated Hours:** 8  
**Dependencies:** TASK-ECO-003  

**Описание:**  
Создать webhook обработчик для получения уведомлений от WooCommerce через Amanita плагин.

**Технические инструкции:**
- Создать `webhook_handler.py` для обработки webhook уведомлений
- Реализовать эндпоинт для получения webhook от Amanita плагина
- Добавить валидацию webhook данных
- Интегрировать с системой уведомлений Telegram
- Добавить обновление статусов в блокчейне
- Реализовать обработку ошибок и retry логику

**Webhook эндпоинт:**
```python
@app.post("/webhook/woocommerce/order-update")
async def handle_order_update(webhook_data: WooCommerceWebhook):
    # 1. Валидация webhook данных
    # 2. Обновление статуса в блокчейне
    # 3. Отправка уведомления в Telegram
    # 4. Логирование результата
```

### TASK-ECO-006: Система уведомлений о заказах
**Task ID:** TASK-ECO-006  
**Story:** US-ECO-004  
**Priority:** High (MVP)  
**Estimated Hours:** 4  
**Dependencies:** TASK-ECO-005  

**Описание:**  
Создать систему уведомлений для информирования покупателей об изменениях статуса заказов в WooCommerce.

**Технические инструкции:**
- Создать `order_notifications.py` для обработки уведомлений
- Интегрировать с существующей системой уведомлений бота
- Добавить шаблоны сообщений для разных статусов
- Реализовать очередь уведомлений для надежности
- Добавить настройки уведомлений для пользователей
- Интегрировать с webhook обработчиком

### TASK-ECO-007: Создание unit тестов для e-commerce функциональности
**Task ID:** TASK-ECO-007  
**Story:** US-ECO-001, US-ECO-002, US-ECO-003, US-ECO-004, US-ECO-005  
**Priority:** High (MVP)  
**Estimated Hours:** 8  
**Dependencies:** TASK-ECO-006  

**Описание:**  
Создать unit тесты для всей e-commerce функциональности в Telegram боте.

**Технические инструкции:**
- Создать `test_catalog_fsm.py` для тестирования каталога
- Создать `test_purchase_fsm.py` для тестирования покупок
- Создать `test_orders_fsm.py` для тестирования заказов
- Создать `test_webhook_handler.py` для тестирования webhook
- Добавить тесты для интеграции с Amanita плагином API
- Создать моки для WooCommerce API
- Обеспечить покрытие кода минимум 85%

---

## Интеграция с Amanita плагином WooCommerce

### Архитектура интеграции

```
[Telegram Bot] ↔ [Amanita WooCommerce Plugin API] ↔ [WooCommerce] ↔ [Blockchain (для трассировки)]
                                    ↓
                            [Webhook] → [Python App] → [Telegram Notifications]
```

### API эндпоинты Amanita плагина (для использования в боте)

**Получение каталога товаров:**
```php
// В Amanita плагине
add_action('rest_api_init', function () {
    register_rest_route('amanita/v1', '/products', array(
        'methods' => 'GET',
        'callback' => 'amanita_get_products_catalog',
        'permission_callback' => 'amanita_check_permissions'
    ));
});

function amanita_get_products_catalog($request) {
    // 1. Получение товаров из WooCommerce
    // 2. Добавление информации о блокчейн статусе
    // 3. Возврат каталога для бота
}
```

**Создание заказа:**
```php
register_rest_route('amanita/v1', '/orders/create', array(
    'methods' => 'POST',
    'callback' => 'amanita_create_order_from_bot',
    'permission_callback' => 'amanita_check_permissions'
));

function amanita_create_order_from_bot($request) {
    // 1. Валидация данных заказа
    // 2. Создание заказа в WooCommerce
    // 3. Запись транзакции в блокчейн для трассировки
    // 4. Возврат результата
}
```

**Получение статуса заказа:**
```php
register_rest_route('amanita/v1', '/orders/{order_id}', array(
    'methods' => 'GET',
    'callback' => 'amanita_get_order_status',
    'permission_callback' => 'amanita_check_permissions'
));
```

**Webhook для уведомлений:**
```php
// В Amanita плагине - перехватчик статусов заказов
add_action('woocommerce_order_status_changed', 'amanita_order_status_changed', 10, 4);

function amanita_order_status_changed($order_id, $old_status, $new_status, $order) {
    // 1. Проверка наличия email у покупателя
    // 2. Если email отсутствует - отправка webhook в Python приложение
    // 3. Webhook содержит информацию о заказе и новом статусе
    // 4. Python приложение отправляет уведомление в Telegram
}
```

### Синхронизация данных

**От Telegram бота к WooCommerce:**
- Создание заказов через Amanita плагин API
- Информация о покупателе
- Детали товаров и цены
- Выбор метода оплаты (manual payment)

**От WooCommerce к Telegram боту:**
- Каталог товаров
- Обновления статуса заказа через webhook
- Информация о доставке
- Уведомления о готовности

**Блокчейн трассировка:**
- Amanita плагин записывает транзакции в блокчейн для трассировки
- Telegram бот не работает напрямую с блокчейном
- Все данные берутся из WooCommerce через плагин

---

## Roadmap - Планы на будущее

### Итерация 2: Оплата токенами AMANITA
- Интеграция с WebApp для оплаты токенами AMANITA
- Автоматическое списание токенов при покупке
- Синхронизация баланса токенов с WooCommerce
- Поддержка скидок за оплату токенами AMANITA

### Итерация 3: Расширенная аналитика
- Аналитика продаж через Telegram бот
- Интеграция с блокчейн аналитикой
- Отчеты по транзакциям и комиссиям
- Дашборд для продавцов

---

## Метрики успеха MVP

### Критические метрики (для запуска первой ноды)
- [ ] Покупатели могут просматривать каталог товаров из WooCommerce в боте
- [ ] Покупатели могут совершать покупки через manual payment методы
- [ ] Заказы создаются в WooCommerce через Amanita плагин
- [ ] Покупатели получают уведомления о статусе заказов через webhook
- [ ] Webhook интеграция работает стабильно

### Технические метрики MVP
- [ ] Покрытие кода unit-тестами ≥ 85%
- [ ] Время отклика каталога < 3 секунды
- [ ] Время обработки заказа < 10 секунд
- [ ] 0 критических багов в e-commerce функциональности
- [ ] Успешная интеграция с Amanita плагином WooCommerce
- [ ] Webhook обработка < 5 секунд

### Бизнес-метрики MVP
- [ ] Полный цикл e-commerce работает через Telegram бот как UI для WooCommerce
- [ ] Интеграция с WooCommerce через Amanita плагин функционирует
- [ ] Система готова для первой моноселлер ноды
- [ ] Покупатели могут совершать покупки без внешних сайтов
- [ ] Все транзакции трассируются в блокчейне через Amanita плагин
- [ ] Manual payment методы работают корректно

---

## Заключение

Данный план обеспечивает создание полноценной моноселлер e-commerce системы в Telegram боте, где бот выступает как дополнительный UI для WooCommerce. Вся бизнес-логика и данные управляются через WooCommerce с интеграцией Amanita плагина, который обеспечивает трассировку транзакций в блокчейне. Система использует стандартные manual payment методы WooCommerce с webhook интеграцией для уведомлений. Фокус направлен на создание полного цикла покупок без необходимости перехода на внешние сайты, что обеспечивает удобство для покупателей и контроль над процессом для продавца. 