# Анализ разрывов в реализации онбординга AMANITA

## Реализованные изменения

**Шаг 0 — Старт бота (/start)**

В рамках первого этапа реализации были выполнены следующие изменения:

1. Создан новый обработчик команды `/start` (`start_onboarding_new`), который:
   - Устанавливает язык пользователя по умолчанию (русский)
   - Формирует приветственное сообщение с использованием лейблов из файла локализации
   - Создает инлайн-клавиатуру с двумя кнопками: "У меня есть приглашение" и "Я уже был(а) здесь"

2. Добавлен обработчик `process_onboarding_choice` для обработки выбора пути онбординга:
   - Путь для нового пользователя с инвайт-кодом
   - Путь для возвращающегося пользователя (восстановление)

3. Обновлен механизм проверки инвайт-кодов для поддержки формата `AMANITA-XXXX-YYYY` вместо старого формата `LOVE-XX-YY`

4. Добавлена возможность для пользователя выбрать между двумя путями онбординга с соответствующими UI элементами

Реализация интегрирована с существующими сервисами:
- `UserSettings` для хранения настроек пользователя
- `Localization` для многоязычного интерфейса
- `BlockchainService` для валидации инвайт-кодов через смарт-контракт

## Обзор

Данный документ представляет собой анализ разрывов (gap analysis) между требуемой функциональностью онбординга, описанной в документе UX-специалиста, и текущей реализацией в Telegram боте и WebApp кошелька.

## Текущая реализация vs Требуемая функциональность

### Шаг 0 — Старт бота (/start)

**Требуемая функциональность:**
- Приветственное сообщение с описанием экосистемы
- Две кнопки: "У меня есть приглашение" и "Я уже был(а) здесь"

**Текущая реализация:**
- ✅ Лейблы для данного шага определены в ru.json
- ❌ Нет обработчика для показа разных путей (вход по инвайту или восстановление)
- ❌ Нет разделения процессов для новых и существующих пользователей

**Разрыв:**
- Необходимо создать обработчик команды /start с нужной логикой и UI-элементами
- Нужно добавить точку входа для "возвращающихся" пользователей

### Шаг 1A — Ввод инвайт-кода

**Требуемая функциональность:**
- Запрос инвайт-кода в формате AMANITA-XXXX-YYYY
- Валидация формата и проверка через API/контракт
- Сообщение об успешной валидации и кнопка для подключения к WebApp

**Текущая реализация:**
- ✅ Лейблы определены в ru.json
- ✅ Есть базовая проверка инвайт-кодов в боте (через BlockchainService)
- ❌ Валидация не использует указанный формат (AMANITA-XXXX-YYYY)
- ❌ Нет обработчика для перехода к WebApp после проверки инвайта

**Разрыв:**
- Адаптировать существующую логику проверки инвайт-кодов под требуемый формат
- Сохранение статуса проверки инвайта реализовано, но требуется завершение интеграции
- Отсутствует прямая передача в WebApp информации о валидации инвайта

### Шаг 1B — Восстановление доступа

**Требуемая функциональность:**
- Интерфейс для возвращающихся пользователей
- Кнопка для открытия WebApp в режиме восстановления

**Текущая реализация:**
- ✅ Лейблы для восстановления определены в ru.json
- ❌ Отсутствует отдельный путь для восстановления доступа в боте
- ❌ WebApp не получает информацию о том, что открыт в режиме восстановления

**Разрыв:**
- Требуется создать отдельный обработчик/маршрут для восстановления доступа
- Необходимо добавить параметр режима восстановления при открытии WebApp

### WebApp: Создание/Восстановление кошелька

**Требуемая функциональность согласно UX документу:**
- Экран 1: Объяснение и кнопка для генерации сид-фразы
- Экран 2: Отображение сид-фразы и инструкция по сохранению
- Экран 3: Установка PIN-кода или биометрической защиты
- Экран 4: Завершение и возврат в бот

**Текущая реализация WebApp:**
- ✅ Реализовано создание кошелька через ethers.js
- ✅ Показ сид-фразы и возможность её скрыть/показать
- ✅ Автоматическое создание кошелька при проверенном инвайте
- ✅ Восстановление по сид-фразе
- ✅ Отправка адреса кошелька боту
- ❌ Отсутствует установка PIN-кода или биометрической защиты
- ❌ Отсутствуют указанные в UX-документе промежуточные экраны
- ❌ Нет поэтапного процесса с объяснениями для пользователя

**Разрыв:**
- Необходимо полностью переработать UI WebApp под требования UX-документа
- Добавить функциональность установки PIN-кода или биометрии
- Создать многоэтапный процесс с объяснениями вместо одноэкранного интерфейса
- Переделать хранение кошелька с учетом дополнительной защиты

### Шаг 3 — Завершение онбординга

**Требуемая функциональность:**
- Сообщение о завершении подключения
- Перечень доступных возможностей
- Навигационные кнопки для перехода к различным разделам

**Текущая реализация:**
- ✅ Обработчик получения данных от WebApp в боте
- ✅ Сохранение адреса кошелька в настройках пользователя
- ❌ Отсутствует полное сообщение о завершении онбординга
- ❌ Нет кнопок навигации по различным разделам экосистемы

**Разрыв:**
- Необходимо дополнить обработчик для формирования полного сообщения
- Добавить кнопки навигации согласно требованиям UX

### Главная навигация и восстановление доступа

**Требуемая функциональность:**
- Команда /menu с набором кнопок для основной навигации
- Механизм восстановления доступа при потере PIN-кода

**Текущая реализация:**
- ✅ Частично реализована команда /menu
- ✅ Есть кнопка /wallet для доступа к кошельку
- ❌ Отсутствуют все указанные в UX кнопки навигации
- ❌ Нет механизма восстановления при потере PIN-кода (т.к. сам PIN не реализован)

**Разрыв:**
- Дополнить команду /menu всеми требуемыми кнопками
- После реализации PIN-кода добавить механизм восстановления

## Итоговый анализ разрывов

### Критические разрывы:
1. **Отсутствие полного процесса онбординга в боте** - необходимо создать законченный сценарий от /start до завершения
2. **Отсутствие защиты PIN-кодом/биометрией в WebApp** - не соответствует требованиям безопасности из UX
3. **Несоответствие UI WebApp** требуемому многоэтапному процессу
4. **Отсутствие восстановления доступа** - нет полной реализации процесса возвращения пользователя

### Средние разрывы:
1. Неполная интеграция между ботом и WebApp - параметры передаются не полностью
2. Отсутствие разделения процессов для новых и существующих пользователей
3. Неполная реализация команды /menu

### Работающая функциональность:
1. ✅ Проверка инвайт-кода (нуждается в изменении формата)
2. ✅ Создание и восстановление кошелька через WebApp
3. ✅ Отправка адреса кошелька обратно в бот
4. ✅ Сохранение кошелька в localStorage (но без требуемой защиты)
5. ✅ Основные лейблы для UI определены в ru.json

## Рекомендации по внедрению

1. **Этап 1:** Полностью реализовать процесс онбординга в боте
   - Создать обработчики для всех шагов из UX-документа
   - Интегрировать существующий механизм валидации инвайтов

2. **Этап 2:** Переработать UI WebApp
   - Разбить на экраны согласно UX-документу
   - Добавить механизм защиты PIN-кодом и биометрией
   - Обеспечить более безопасное хранение данных кошелька

3. **Этап 3:** Доработать интеграцию
   - Обеспечить полную передачу параметров между ботом и WebApp
   - Дополнить механизм восстановления доступа
   
4. **Этап 4:** Завершить разработку нвигации и дополнительного функционала
   - Реализовать полную версию /menu
   - Добавить возможности управления приглашениями, просмотра каталога и т.д.

## Валидация результатов реализации

### Проверка критериев приемки

По результатам реализации Шага 0 можно провести следующую валидацию:

**1. Обработчик команды /start:**
- ✅ Создан обработчик `start_onboarding_new` для команды /start
- ✅ Функция успешно извлекает ID пользователя и его языковые настройки
- ✅ Реализовано логирование начала и завершения обработки
- ✅ Реализовано корректное сохранение/получение языка через UserSettings

**2. Приветственное сообщение:**
- ✅ Сообщение содержит все элементы из UX-документа:
  - Заголовок (welcome_title)
  - Описание (welcome_description)
  - Инструкция (welcome_instruction)
  - Текст выбора (welcome_choose)
- ✅ Используются корректные лейблы из ru.json
- ✅ Форматирование обеспечивает читаемость с переносами строк

**3. Кнопки выбора пути:**
- ✅ Реализованы две кнопки с корректными лейблами:
  - "🌱 У меня есть приглашение" (onboarding.btn_have_invite)
  - "🔄 Я уже был(а) здесь" (onboarding.btn_restore)
- ✅ Кнопки передают корректные callback_data для обработки
- ✅ UI соответствует UX-документу (расположение кнопок)

**4. Обработка выбора пути:**
- ✅ Реализован обработчик `process_onboarding_choice`
- ✅ Корректная маршрутизация для нового пользователя с инвайт-кодом
- ✅ Корректная маршрутизация для возвращающегося пользователя

**5. Валидация инвайт-кода:**
- ✅ Обновлена логика проверки формата инвайт-кода на AMANITA-XXXX-YYYY
- ✅ Сохранена интеграция с BlockchainService для валидации

### Оставшиеся задачи

Чтобы полностью соответствовать UX-документу, необходимо:

1. Добавить URL для режима восстановления в WebApp
2. Реализовать интеграцию между проверкой инвайт-кода и последующим открытием WebApp
3. Доработать WebApp для поддержки режима восстановления и защиты PIN-кодом/биометрией
4. Завершить полный цикл онбординга с завершающим сообщением
