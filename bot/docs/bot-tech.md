# Техническая документация по Telegram-боту AMANITA

## Работа с лейблами и переводами

Если вы изменяете или обновляете лейблы (текстовые подписи, сообщения, кнопки и т.д.) в русском языковом файле, обязательно добавляйте к изменённому значению на русском префикс `changed_`. Это необходимо для корректной работы скрипта автоматического перевода и отслеживания изменений.

**Пример:**

```json
"greeting": "Добро пожаловать!",         // старый вариант
"greeting": "changed_Приветствуем!"    // изменённый вариант
```

После внесения изменений не забудьте запустить скрипт для перевода, чтобы актуализировать остальные языковые файлы.

# Onboarding

1. Основная структура директорий и файлов
main.py — точка входа, инициализация бота, регистрация хендлеров, запуск polling.
config.py — конфигурация (например, переменные окружения).
services/ — сервисы для работы с внешними системами и бизнес-логикой:
blockchain.py — универсальный слой для работы с web3 и контрактом InviteNFT (и другими контрактами). Содержит класс BlockchainService с методами для всех операций с инвайтами, пользователями, событиями.
onboarding_flow.py — функции для сценариев онбординга (например, после выбора языка).
localization.py — сервис для локализации сообщений (работа с json-файлами в templates).
invite.py — (пока пустой) предполагается как сервис для работы с инвайт-кодами.
handlers/ — обработчики команд и событий Telegram:
onboarding.py — логика онбординга пользователя, выбор языка, обработка кнопок, переход к вводу инвайта.
language.py — обработка смены языка.
help.py, errors.py — обработка справки и ошибок.
utils/ — утилиты (логгер, валидаторы и др.).
keyboards/ — генерация клавиатур для Telegram (например, для онбординга).
middlewares/ — мидлвари для aiogram (например, для языка).
templates/ — json-файлы с переводами для разных языков.
tests/ — интеграционные и юнит-тесты.
2. Логика работы с инвайтами и онбордингом
Вся работа с контрактом InviteNFT инкапсулирована в BlockchainService (services/blockchain.py):
Методы для получения информации об инвайтах: getTokenIdByInviteCode, isInviteTokenUsed, ownerOf, getInviteCreatedAt, getInviteExpiry, getInviteMinter, getInviteFirstOwner, isUserActivated, getUserInvites и др.
Методы для валидации и активации инвайтов.
Вызовы функций контракта через web3.
Вся логика пользовательского онбординга реализована в хендлерах:
handlers/onboarding.py — обработка команды /start, выбор языка, переход к проверке инвайта.
После выбора языка вызывается onboarding_after_language (services/onboarding_flow.py), где пользователю показывается приветствие и кнопка для перехода к вводу инвайта.
Локализация сообщений реализована через класс Localization (services/localization.py), который загружает нужный json-файл из templates/ и позволяет получать переводы по ключу.
3. Как реализуется flow онбординга в коде
Пользователь отправляет /start — срабатывает start_onboarding, предлагается выбрать язык.
После выбора языка вызывается onboarding_after_language, показывается приветствие и кнопка "Далее".
При нажатии "Далее" — предлагается ввести или подтвердить инвайт-код.
Дальнейшая логика (валидация инвайта, активация, генерация новых инвайтов) реализуется через методы BlockchainService и соответствующие хендлеры (их можно расширять для полноценного сценария, как в тесте).
4. Выводы
Вся работа с блокчейном и InviteNFT реализована централизованно в сервисе blockchain.py.
Вся логика пользовательского сценария (онбординг, ввод инвайта, генерация новых инвайтов) реализуется через хендлеры и сервисы.
Локализация сообщений полностью вынесена в отдельный сервис и шаблоны.
Тесты (например, test_onboarding_integration.py) моделируют реальный flow, который реализуется в боте через эти сервисы и хендлеры.