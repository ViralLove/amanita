# User Story: Внедрение Dependency Override для внешних сервисов FastAPI

**Как** разработчик,
**Я хочу** чтобы все внешние сервисы (IPFS, blockchain, сторонние API) во всём FastAPI-приложении внедрялись через Depends,
**Чтобы** я мог легко подменять их на моки через dependency_overrides для изолированного тестирования и интеграции.

---

## Acceptance Criteria
- ✅ Все внешние сервисы внедряются через Depends.
- ✅ Нет прямых вызовов фабрик/синглтонов для сервисов в коде приложения.
- ✅ В тестах можно подменить любой сервис на мок через dependency_overrides.
- ✅ Документация обновлена.

---

## Technical Subtasks

1. **✅ Анализ точек использования внешних сервисов**
   - Найдены все места, где используются ProductStorageService, BlockchainService и другие внешние сервисы.

2. **✅ Вынести создание сервисов в зависимости**
   - Созданы функции-зависимости в `bot/dependencies.py` и `bot/api/dependencies.py` для всех сервисов.

3. **✅ Внедрить Depends во все endpoint-ы и сервисы**
   - API endpoint `/products/upload` теперь использует `Depends(get_product_registry_service)`.

4. **✅ Прокинуть зависимости во вложенные сервисы**
   - Исправлена циклическая зависимость в `get_product_registry_service`.

5. **✅ Удалить прямые вызовы фабрик/синглтонов**
   - API endpoint больше не создает сервисы напрямую.

6. **✅ Обновить тесты для использования dependency_overrides**
   - Тест `test_create_product_ipfs_error` адаптирован к новой системе DI.
   - Используется `app.dependency_overrides[get_product_storage_service]` для подмены сервисов.

7. **✅ Обновить документацию**
   - Описано в README и API Docs, как подменять зависимости для тестирования.

8. **✅ Проверить корректность работы приложения и тестов**
   - Все тесты проходят успешно.
   - Внешние вызовы можно замокировать через dependency_overrides.

---

## Реализованные изменения

### Файлы с изменениями:
- `bot/dependencies.py` - общий модуль зависимостей
- `bot/api/dependencies.py` - API-специфичные зависимости с FastAPI Depends
- `bot/api/routes/products.py` - адаптирован к использованию DI
- `bot/tests/api/test_products_unit.py` - тесты адаптированы к новой системе DI

### Ключевые особенности реализации:
- **Обратная совместимость**: старый способ создания сервисов все еще работает
- **Изоляция тестов**: можно подменять только внешние сервисы, оставляя бизнес-логику реальной
- **Гибкость**: dependency_overrides позволяют легко настраивать моки для разных тестовых сценариев
