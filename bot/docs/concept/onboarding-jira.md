# Epic: Система онбординга AMANITA - Реальные улучшения

## Epic: EPIC-ONB-001 - Безопасность и валидация онбординга
**Epic ID:** EPIC-ONB-001  
**Epic Description:** Обеспечение безопасности и надежной валидации процесса онбординга для защиты экосистемы AMANITA

---

## User Story: Валидация инвайт-кодов через блокчейн

### US-ONB-001: Как система безопасности, я хочу валидировать инвайт-коды через смарт-контракт, чтобы обеспечить подлинность и актуальность приглашений в закрытую экосистему

**Story ID:** US-ONB-001  
**Priority:** Critical (MVP)  
**Story Points:** 13  
**Sprint:** Sprint 1  
**Assignee:** Blockchain Team  
**QA:** QA Team  

### Описание
В настоящее время система проверяет только формат инвайт-кода (`AMANITA-XXXX-XXXX`), но не валидирует его существование и статус в блокчейне. Это критично для безопасности закрытой экосистемы, так как позволяет использовать несуществующие или уже использованные коды.

### Критерии приемки (Acceptance Criteria)

#### AC-ONB-001.1: Проверка существования инвайт-кода
- **Given** пользователь вводит инвайт-код в формате `AMANITA-XXXX-XXXX`
- **When** система выполняет валидацию через смарт-контракт `InviteNFT`
- **Then** система проверяет существование кода в блокчейне
- **And** система возвращает результат валидации с детальным описанием

#### AC-ONB-001.2: Проверка статуса использования кода
- **Given** инвайт-код существует в блокчейне
- **When** система проверяет статус использования
- **Then** система определяет, был ли код уже использован
- **And** система блокирует повторное использование кода

#### AC-ONB-001.3: Проверка срока действия инвайта
- **Given** инвайт-код не использован
- **When** система проверяет срок действия
- **Then** система определяет, не истек ли срок действия кода
- **And** система блокирует использование просроченных кодов

#### AC-ONB-001.4: Обработка ошибок блокчейн-валидации
- **Given** возникает ошибка при обращении к блокчейну
- **When** система не может выполнить валидацию
- **Then** система возвращает понятное сообщение об ошибке
- **And** система предлагает повторить попытку позже

#### AC-ONB-001.5: Логирование операций валидации
- **Given** выполняется валидация инвайт-кода
- **When** система обрабатывает запрос
- **Then** система логирует все операции валидации
- **And** система сохраняет результаты для аудита

### Определение готовности (Definition of Ready)
- [ ] Смарт-контракт `InviteNFT` развернут и протестирован
- [ ] Методы валидации в контракте реализованы
- [ ] Тестовые инвайт-коды подготовлены
- [ ] Моки для тестирования готовы

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Код покрыт unit-тестами (минимум 90%)
- [ ] Интеграционные тесты с блокчейном написаны
- [ ] Документация API обновлена
- [ ] Код прошел code review

---

## User Story: Безопасность WebApp интеграции

### US-ONB-002: Как система безопасности, я хочу валидировать данные от Telegram WebApp, чтобы предотвратить подмену параметров и защитить кошельки пользователей

**Story ID:** US-ONB-002  
**Priority:** Critical (MVP)  
**Story Points:** 8  
**Sprint:** Sprint 1  
**Assignee:** Security Team  
**QA:** QA Team  

### Описание
WebApp получает параметры из URL и `initDataUnsafe`, но не проверяет их подлинность. Это критично для безопасности кошельков пользователей, так как может привести к подмене параметров и компрометации данных.

### Критерии приемки (Acceptance Criteria)

#### AC-ONB-002.1: HMAC-валидация данных от Telegram
- **Given** WebApp получает данные от Telegram
- **When** система обрабатывает `initData`
- **Then** система проверяет HMAC-подпись данных
- **And** система отклоняет невалидные данные

#### AC-ONB-002.2: Проверка подписи initData
- **Given** данные прошли HMAC-валидацию
- **When** система обрабатывает параметры
- **Then** система проверяет подлинность подписи
- **And** система использует секретный ключ бота для проверки

#### AC-ONB-002.3: Защита от CSRF-атак
- **Given** WebApp обрабатывает запросы
- **When** система получает данные
- **Then** система проверяет источник запроса
- **And** система отклоняет запросы от неавторизованных источников

#### AC-ONB-002.4: Валидация параметров URL
- **Given** WebApp получает параметры из URL
- **When** система обрабатывает параметры
- **Then** система валидирует формат и содержимое параметров
- **And** система отклоняет некорректные параметры

### Определение готовности (Definition of Ready)
- [ ] Секретный ключ бота настроен
- [ ] Документация Telegram WebApp API изучена
- [ ] Тестовые данные для валидации подготовлены

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Код покрыт unit-тестами (минимум 90%)
- [ ] Security review проведен
- [ ] Документация безопасности обновлена

---

## Epic: EPIC-ONB-002 - Обработка ошибок и надежность

**Epic ID:** EPIC-ONB-002  
**Epic Description:** Обеспечение надежной обработки ошибок и восстановления после сбоев в процессе онбординга

---

## User Story: Обработка ошибок блокчейн-транзакций

### US-ONB-003: Как пользователь, я хочу получать понятные сообщения об ошибках при проблемах с блокчейном, чтобы понимать, что происходит и что делать дальше

**Story ID:** US-ONB-003  
**Priority:** High (MVP)  
**Story Points:** 5  
**Sprint:** Sprint 2  
**Assignee:** Backend Team  
**QA:** QA Team  

### Описание
При сбоях блокчейн-операций пользователь остается в неопределенном состоянии, что может привести к потере данных и повторным попыткам. Необходимо обеспечить надежную обработку ошибок и восстановление.

### Критерии приемки (Acceptance Criteria)

#### AC-ONB-003.1: Retry-механизм для транзакций
- **Given** возникает временная ошибка блокчейна
- **When** система выполняет транзакцию
- **Then** система автоматически повторяет попытку
- **And** система ограничивает количество попыток

#### AC-ONB-003.2: Fallback-стратегии
- **Given** блокчейн недоступен
- **When** система не может выполнить операцию
- **Then** система использует альтернативные методы
- **And** система уведомляет пользователя о проблеме

#### AC-ONB-003.3: Система уведомлений об ошибках
- **Given** возникает ошибка в процессе онбординга
- **When** система обрабатывает ошибку
- **Then** система отправляет понятное сообщение пользователю
- **And** система предлагает варианты решения

#### AC-ONB-003.4: Сохранение состояния при ошибках
- **Given** возникает ошибка в процессе онбординга
- **When** система обрабатывает ошибку
- **Then** система сохраняет текущее состояние
- **And** система позволяет продолжить с того же места

### Определение готовности (Definition of Ready)
- [ ] Типы ошибок блокчейна определены
- [ ] Стратегии восстановления разработаны
- [ ] Тестовые сценарии ошибок подготовлены

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Код покрыт unit-тестами (минимум 85%)
- [ ] Тестирование в staging-окружении завершено

---

## Epic: EPIC-ONB-003 - Производительность и масштабируемость

**Epic ID:** EPIC-ONB-003  
**Epic Description:** Оптимизация производительности и обеспечение масштабируемости системы онбординга

---

## User Story: Кэширование языковых файлов

### US-ONB-004: Как система, я хочу кэшировать языковые файлы, чтобы ускорить ответы бота и снизить нагрузку на сервер

**Story ID:** US-ONB-004  
**Priority:** Medium (MVP)  
**Story Points:** 3  
**Sprint:** Sprint 2  
**Assignee:** Backend Team  
**QA:** QA Team  

### Описание
В настоящее время языковые файлы загружаются при каждом запросе, что замедляет ответы бота и увеличивает нагрузку на сервер. Необходимо реализовать кэширование для оптимизации производительности.

### Критерии приемки (Acceptance Criteria)

#### AC-ONB-004.1: Кэширование в памяти
- **Given** система загружает языковой файл
- **When** файл загружен впервые
- **Then** система сохраняет его в кэше памяти
- **And** система использует кэшированную версию при повторных запросах

#### AC-ONB-004.2: TTL для обновления переводов
- **Given** языковой файл находится в кэше
- **When** истекает TTL
- **Then** система обновляет кэш из файла
- **And** система логирует обновление

#### AC-ONB-004.3: Оптимизация загрузки JSON
- **Given** система загружает языковые файлы
- **When** файлы загружаются
- **Then** система использует эффективные методы парсинга
- **And** система минимизирует время загрузки

### Определение готовности (Definition of Ready)
- [ ] Требования к производительности определены
- [ ] Стратегия кэширования разработана
- [ ] Тестовые данные подготовлены

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Производительность улучшена на 50%
- [ ] Код покрыт unit-тестами (минимум 85%)

---

## Epic: EPIC-ONB-004 - Тестирование и качество

**Epic ID:** EPIC-ONB-004  
**Epic Description:** Обеспечение качества и надежности системы онбординга через комплексное тестирование

---

## User Story: Комплексное тестирование онбординга

### US-ONB-005: Как QA команда, я хочу иметь полное покрытие тестами системы онбординга, чтобы гарантировать качество и надежность

**Story ID:** US-ONB-005  
**Priority:** High (MVP)  
**Story Points:** 8  
**Sprint:** Sprint 3  
**Assignee:** QA Team  
**QA:** QA Team  

### Описание
Существующая система онбординга имеет базовую функциональность, но отсутствует комплексное тестирование всех сценариев, что может привести к проблемам в production.

### Критерии приемки (Acceptance Criteria)

#### AC-ONB-005.1: Unit-тесты для всех компонентов
- **Given** система онбординга имеет множество компонентов
- **When** выполняется тестирование
- **Then** каждый компонент покрыт unit-тестами
- **And** покрытие кода составляет минимум 90%

#### AC-ONB-005.2: Интеграционные тесты
- **Given** система интегрируется с WebApp и блокчейном
- **When** выполняется интеграционное тестирование
- **Then** все интеграционные сценарии протестированы
- **And** тесты покрывают успешные и неуспешные сценарии

#### AC-ONB-005.3: End-to-end тесты
- **Given** пользователь проходит полный процесс онбординга
- **When** выполняется E2E тестирование
- **Then** все пользовательские сценарии протестированы
- **And** тесты включают различные устройства и браузеры

#### AC-ONB-005.4: Тесты производительности
- **Given** система должна работать под нагрузкой
- **When** выполняется нагрузочное тестирование
- **Then** система выдерживает ожидаемую нагрузку
- **And** время отклика остается в допустимых пределах

### Определение готовности (Definition of Ready)
- [ ] Тестовые сценарии определены
- [ ] Тестовая среда настроена
- [ ] Моки и фикстуры подготовлены

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Тесты автоматизированы и интегрированы в CI/CD
- [ ] Документация по тестированию создана

---

## Epic: EPIC-ONB-005 - Мониторинг и аналитика

**Epic ID:** EPIC-ONB-005  
**Epic Description:** Обеспечение мониторинга и аналитики системы онбординга для оптимизации процесса

---

## User Story: Аналитика и метрики онбординга

### US-ONB-006: Как продуктовая команда, я хочу иметь детальную аналитику процесса онбординга, чтобы оптимизировать конверсию

**Story ID:** US-ONB-006  
**Priority:** Medium (MVP)  
**Story Points:** 5  
**Sprint:** Sprint 3  
**Assignee:** Analytics Team  
**QA:** QA Team  

### Описание
Отсутствует детальная аналитика процесса онбординга, что затрудняет понимание, где пользователи теряются и какие этапы требуют улучшения.

### Критерии приемки (Acceptance Criteria)

#### AC-ONB-006.1: Сбор метрик конверсии
- **Given** пользователи проходят онбординг
- **When** система отслеживает процесс
- **Then** система собирает метрики конверсии по этапам
- **And** система предоставляет аналитические отчеты

#### AC-ONB-006.2: Анализ воронки онбординга
- **Given** система собирает данные о прохождении онбординга
- **When** данные анализируются
- **Then** система показывает воронку конверсии
- **And** система выявляет узкие места

#### AC-ONB-006.3: A/B тестирование
- **Given** есть различные варианты онбординга
- **When** выполняется A/B тестирование
- **Then** система сравнивает эффективность вариантов
- **And** система предоставляет статистически значимые результаты

### Определение готовности (Definition of Ready)
- [ ] Требования к аналитике определены
- [ ] Инструменты аналитики настроены
- [ ] Метрики определены

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Дашборд аналитики развернут
- [ ] Документация по аналитике создана

---

## Технические задачи (MVP для запуска первых магазинов)

### TASK-ONB-001: Реализация валидации инвайт-кодов через блокчейн
**Task ID:** TASK-ONB-001  
**Story:** US-ONB-001  
**Priority:** Critical (MVP)  
**Estimated Hours:** 16  
**Dependencies:** None  

**Описание:**  
Реализовать реальную валидацию инвайт-кодов через смарт-контракт `InviteNFT` в `blockchain.py`. Заменить заглушку на реальные вызовы контракта.

**Технические инструкции:**
- Обновить метод `validate_invite_code()` в `BlockchainService`
- Добавить проверку существования кода через `getTokenIdByInviteCode`
- Реализовать проверку статуса использования через `isInviteTokenUsed`
- Добавить проверку срока действия через `getInviteExpiry`
- Интегрировать с существующей системой логирования
- Добавить обработку ошибок блокчейна

### TASK-ONB-002: Реализация HMAC-валидации WebApp данных
**Task ID:** TASK-ONB-002  
**Story:** US-ONB-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 12  
**Dependencies:** None  

**Описание:**  
Реализовать валидацию данных от Telegram WebApp в `main.js`. Добавить проверку HMAC-подписи и защиту от CSRF-атак.

**Технические инструкции:**
- Добавить функцию `validateTelegramData()` в `main.js`
- Реализовать проверку HMAC-подписи `initData`
- Добавить валидацию параметров URL
- Реализовать защиту от CSRF-атак
- Добавить обработку ошибок валидации
- Интегрировать с существующей системой уведомлений

### TASK-ONB-003: Реализация retry-механизма для блокчейн-операций
**Task ID:** TASK-ONB-003  
**Story:** US-ONB-003  
**Priority:** High (MVP)  
**Estimated Hours:** 8  
**Dependencies:** TASK-ONB-001  

**Описание:**  
Реализовать retry-механизм и fallback-стратегии для блокчейн-операций в `onboarding_fsm.py`.

**Технические инструкции:**
- Добавить декоратор `@retry` для блокчейн-операций
- Реализовать fallback-стратегии при недоступности блокчейна
- Добавить систему уведомлений об ошибках
- Реализовать сохранение состояния при ошибках
- Добавить детальное логирование ошибок

### TASK-ONB-004: Реализация кэширования языковых файлов
**Task ID:** TASK-ONB-004  
**Story:** US-ONB-004  
**Priority:** Medium (MVP)  
**Estimated Hours:** 6  
**Dependencies:** None  

**Описание:**  
Реализовать кэширование языковых файлов в `Localization` сервисе для оптимизации производительности.

**Технические инструкции:**
- Добавить кэш в памяти для языковых файлов
- Реализовать TTL для обновления переводов
- Оптимизировать загрузку JSON-файлов
- Добавить инвалидацию кэша при изменении файлов
- Реализовать fallback на файловую систему

### TASK-ONB-005: Создание комплексных тестов онбординга
**Task ID:** TASK-ONB-005  
**Story:** US-ONB-005  
**Priority:** High (MVP)  
**Estimated Hours:** 12  
**Dependencies:** None  

**Описание:**  
Создать комплексные тесты для системы онбординга, включая unit, интеграционные и E2E тесты.

**Технические инструкции:**
- Расширить существующий файл `test_onboarding_integration.py`
- Добавить unit-тесты для всех компонентов онбординга
- Создать интеграционные тесты с WebApp и блокчейном
- Реализовать E2E тесты для полного процесса
- Добавить тесты производительности
- Обеспечить покрытие кода минимум 90%

### TASK-ONB-006: Реализация аналитики онбординга
**Task ID:** TASK-ONB-006  
**Story:** US-ONB-006  
**Priority:** Medium (MVP)  
**Estimated Hours:** 10  
**Dependencies:** None  

**Описание:**  
Реализовать систему аналитики для отслеживания метрик онбординга и оптимизации конверсии.

**Технические инструкции:**
- Добавить сбор метрик в `onboarding_fsm.py`
- Реализовать отслеживание воронки конверсии
- Создать дашборд аналитики
- Добавить A/B тестирование
- Интегрировать с существующей системой логирования

---

## Метрики успеха MVP

### Критические метрики (для запуска первых магазинов)
- [ ] 3 критических user stories выполнены (US-ONB-001, US-ONB-002, US-ONB-003)
- [ ] 90% покрытие тестами MVP функционала
- [ ] Время валидации инвайт-кода < 5 секунд
- [ ] 0 критических уязвимостей безопасности в MVP

### Технические метрики MVP
- [ ] Покрытие кода unit-тестами ≥ 90%
- [ ] Время отклика системы онбординга < 10 секунд
- [ ] 0 security vulnerabilities в MVP коде
- [ ] Документация безопасности обновлена

### Бизнес-метрики MVP
- [ ] MVP система онбординга готова для production
- [ ] Поддержка всех базовых сценариев онбординга
- [ ] Соответствие минимальным требованиям безопасности
- [ ] Готовность к запуску первых магазинов-нод

### Полные метрики (после реализации всех epics)
- [ ] Все 6 user stories выполнены
- [ ] 100% покрытие тестами всех компонентов
- [ ] Время отклика системы < 5 секунд
- [ ] Покрытие кода unit-тестами ≥ 95%
- [ ] Покрытие кода интеграционными тестами ≥ 90%
- [ ] Поддержка всех сценариев онбординга
- [ ] Полная документация для интеграторов
