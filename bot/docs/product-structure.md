# Структура продукта в Amanita

## Обзор

В системе Amanita продукт имеет два ключевых идентификатора:
- **`business_id`** - бизнес-логический идентификатор (строка)
- **`blockchain_id`** - числовой идентификатор в блокчейне (uint256)

## Business ID (`business_id`)

### Определение
`business_id` - это строковый идентификатор продукта, который используется в бизнес-логике приложения. Это человекочитаемый ID, который может содержать буквы, цифры и специальные символы.

### Логика получения
1. **Создание**: `business_id` задается при создании продукта в поле `id` входных данных
2. **Валидация**: Проверяется уникальность через `_check_product_id_exists()`
3. **Хранение**: Сохраняется в метаданных продукта в IPFS

### Назначение
- Уникальная идентификация продукта в бизнес-логике
- Используется для поиска и фильтрации продуктов
- Связывает продукт с внешними системами (каталоги, заказы)
- Человекочитаемый формат для администраторов и пользователей

### Жизненный цикл
```
Создание продукта → Валидация уникальности → Сохранение в метаданных → Использование в API
```

## Blockchain ID (`blockchain_id`)

### Определение
`blockchain_id` - это числовой идентификатор продукта в смарт-контракте ProductRegistry. Это автоматически генерируемый uint256, который присваивается при записи в блокчейн.

### Логика получения
1. **Создание в блокчейне**: Вызывается `createProduct(ipfsCID)` в контракте
2. **Генерация ID**: Контракт увеличивает `_productIdCounter` и присваивает новый ID
3. **Извлечение из транзакции**: Через `get_product_id_from_tx(tx_hash)` парсится событие `ProductCreated`
4. **Проверка существования**: Валидируется через `_check_blockchain_product_exists(blockchain_id)`

### Назначение
- Уникальная идентификация продукта в блокчейне
- Используется для вызова функций смарт-контракта (активация, деактивация, обновление)
- Связывает метаданные IPFS с записью в блокчейне
- Обеспечивает неизменность и прозрачность

### Жизненный цикл
```
Создание метаданных → Загрузка в IPFS → Запись в блокчейн → Получение blockchain_id → Валидация → Использование
```

## Связь между идентификаторами

### Создание продукта
```python
# 1. Создание метаданных с business_id
metadata = {
    "id": "amanita_muscaria_powder_100g",  # business_id
    "title": "Amanita Muscaria Powder 100g",
    # ... другие поля
}

# 2. Загрузка в IPFS
metadata_cid = await storage_service.upload_json(metadata)

# 3. Запись в блокчейн
tx_hash = await blockchain_service.create_product(metadata_cid)

# 4. Получение blockchain_id
blockchain_id = await blockchain_service.get_product_id_from_tx(tx_hash)
```

### Структура в блокчейне
```solidity
struct Product {
    uint256 id;          // blockchain_id
    address seller;      // Адрес продавца
    string ipfsCID;      // CID метаданных в IPFS
    bool active;         // Статус активности
}
```

### Событие ProductCreated
```solidity
event ProductCreated(
    address indexed seller,
    uint256 productId,   // blockchain_id
    string ipfsCID,      // CID метаданных
    uint256 status       // Статус (0 - неактивный)
);
```

## Валидация и проверки

### Business ID
- Проверка уникальности в системе
- Валидация формата и длины
- Проверка на запрещенные символы

### Blockchain ID
- Проверка существования в смарт-контракте
- Валидация через `getProduct(blockchain_id)`
- Проверка статуса активности

## Использование в API

### Создание продукта
```python
result = await registry.create_product(product_data)
# Возвращает:
{
    "id": "business_id",
    "metadata_cid": "Qm...",
    "blockchain_id": "123",
    "tx_hash": "0x...",
    "status": "success"
}
```

### Получение продукта
```python
# По business_id
product = registry.get_product("amanita_muscaria_powder_100g")

# По blockchain_id (через блокчейн)
product_data = blockchain_service.get_product(123)
```

### Обновление статуса
```python
# Используется blockchain_id
await blockchain_service.set_product_active(
    private_key, 
    blockchain_id=123, 
    is_active=True
)
```

## Кэширование и производительность

### Кэш метаданных
- Метаданные кэшируются по IPFS CID
- Время жизни: 24 часа для описаний, 12 часов для изображений
- Автоматическая инвалидация при обновлении

### Кэш каталога
- Список продуктов кэшируется на 5 минут
- Версия каталога отслеживается в блокчейне
- Автоматическое обновление при изменениях

## Обработка ошибок

### Business ID конфликты
- Проверка уникальности перед созданием
- Возврат ошибки с описанием конфликта
- Возможность изменения ID пользователем

### Blockchain ID ошибки
- Проверка существования после создания
- Логирование предупреждений при расхождениях
- Повторные попытки получения ID из транзакции

## Безопасность

### Валидация входных данных
- Проверка CID через регулярные выражения
- Валидация обязательных полей
- Санитизация пользовательского ввода

### Контроль доступа
- Проверка активации пользователя через InviteNFT
- Проверка прав продавца на продукт
- Аудит всех операций через события блокчейна
