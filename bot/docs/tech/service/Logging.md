# Документация по логированию в AMANITA Python Microservice

## Текущая архитектура логирования

### 1. Централизация инициализации
- Вся логика логирования вынесена в отдельные утилиты:
  - `bot/utils/sentry_init.py` — отвечает за инициализацию Sentry (отправка ошибок во внешний сервис).
  - `bot/utils/logging_setup.py` — отвечает за настройку файлового и консольного логирования (структурированный JSON, ротация файлов, форматирование).
- В точках входа (`main.py`, `api/main.py`) всегда вызывается:
  1. `init_sentry()` — инициализация Sentry только если это production/uat и явно включено через переменные окружения.
  2. `setup_logging(...)` — настройка логгера `amanita_api` для файлового и консольного вывода.

### 2. Гибкая конфигурация через переменные окружения
- Все параметры логирования и мониторинга задаются через `.env`:
  - `AMANITA_API_ENVIRONMENT` — окружение (development, production, uat и т.д.)
  - `SENTRY_ENABLED` — включать ли отправку ошибок в Sentry (true/false)
  - `SENTRY_DSN` — DSN для Sentry (боевой или тестовый)
  - `AMANITA_API_LOG_FILE` — путь к файлу логов
  - `AMANITA_API_LOG_MAX_SIZE`, `AMANITA_API_LOG_BACKUP_COUNT` — параметры ротации файлов
- Это позволяет легко переключаться между dev/prod/uat режимами без изменения кода.

### 3. Как пишутся логи
- **В dev-режиме:**
  - Все логи пишутся в файл (структурированный JSON, ротация) и в консоль (человекочитаемый формат).
  - Sentry не инициализируется, ошибки не отправляются во внешний сервис.
- **В production/uat:**
  - Логи также пишутся в файл (для аудита и резервного хранения).
  - Ошибки и критические события отправляются в Sentry (если включено через переменные окружения).
- Все модули используют единый логгер `amanita_api`, что обеспечивает консистентность и простоту поиска.

### 4. Пример конфигурации
```env
# .env для разработки
AMANITA_API_ENVIRONMENT=development
SENTRY_ENABLED=false
SENTRY_DSN=
AMANITA_API_LOG_FILE=logs/test_api.log
AMANITA_API_LOG_MAX_SIZE=10485760
AMANITA_API_LOG_BACKUP_COUNT=5

# .env для production
AMANITA_API_ENVIRONMENT=production
SENTRY_ENABLED=true
SENTRY_DSN=ваш_боевой_DSN
AMANITA_API_LOG_FILE=logs/prod_api.log
AMANITA_API_LOG_MAX_SIZE=10485760
AMANITA_API_LOG_BACKUP_COUNT=5
```

### 5. Почему так сделано (обоснования)
- **Безопасность:** тестовые ошибки не попадают в боевой Sentry, нет риска засорить продакшн-логи.
- **Гибкость:** можно быстро переключать режимы через переменные окружения, не меняя код.
- **Централизация:** вся логика логирования и мониторинга в одном месте, легко поддерживать и расширять.
- **Масштабируемость:** легко добавить новые внешние системы (Loki, ELK, Datadog и т.д.) по аналогии.
- **Прозрачность:** всегда понятно, куда идут логи и ошибки, легко анализировать и искать нужные события.
- **Аудит и расследование:** даже в production все логи сохраняются в файл для последующего анализа.
- **Тестируемость:** в тестах Sentry всегда мокается, чтобы не было случайных отправок.

### 6. Как расширять
- Для интеграции с другими системами (Loki, ELK) — добавить соответствующий обработчик в `setup_logging`.
- Для алертов — настраивать их в Sentry или внешних системах.
- Для аудита — можно добавить отдельный логгер или канал.

---

## Инструкции для работы с логированием

### Для локальной разработки (dev)
1. Убедитесь, что в `.env`:
   - `AMANITA_API_ENVIRONMENT=development`
   - `SENTRY_ENABLED=false`
   - `AMANITA_API_LOG_FILE=logs/test_api.log`
2. Запускайте приложение как обычно (`python bot/main.py` или через тесты).
3. Все логи будут писаться:
   - В консоль (человекочитаемый формат, INFO/DEBUG/ERROR)
   - В файл `logs/test_api.log` (структурированный JSON)
4. Для просмотра логов:
   - Быстро: `tail -f logs/test_api.log`
   - Для анализа: открывайте файл в редакторе или используйте `jq` для фильтрации по уровню/полю
5. Ошибки и исключения НЕ отправляются в Sentry, только пишутся в файл и консоль.
6. Для тестов мок Sentry пишет события в `logs/sentry_mock.log` (см. тесты).

### Для production/UAT
1. В `.env`:
   - `AMANITA_API_ENVIRONMENT=production` (или `uat`)
   - `SENTRY_ENABLED=true`
   - `SENTRY_DSN=ваш_боевой_DSN`
   - `AMANITA_API_LOG_FILE=logs/prod_api.log`
2. Запускайте приложение как обычно (через systemd, docker, etc).
3. Все логи будут писаться:
   - В файл `logs/prod_api.log` (структурированный JSON, ротация)
   - В консоль (если не отключено в настройках сервиса)
4. Ошибки и критические события (exceptions, logging.error/critical) будут автоматически отправляться в Sentry:
   - В Sentry можно искать, фильтровать, строить алерты по exception, trace, user context и т.д.
   - Sentry группирует одинаковые ошибки, показывает stacktrace, контекст запроса, пользователя и т.д.
5. Для аудита и расследования инцидентов используйте логи из файла (`logs/prod_api.log`).
6. Для поиска по уровням:
   - В файле лога ищите по полю `"level"` (например, ERROR, WARNING, INFO, DEBUG)
   - Для фильтрации используйте `jq`:
     ```bash
     jq 'select(.level=="ERROR")' logs/prod_api.log
     ```

### Примечания
- Sentry автоматически обрабатывает все необработанные исключения (exceptions), а также любые вызовы `logging.error`/`logging.critical` (если интеграция настроена через LoggingIntegration).
- В Sentry удобно отслеживать только ошибки и критические сбои, а для бизнес-логики и аудита используйте файлы логов.
- Для интеграции с другими системами (Loki, ELK) — добавьте соответствующий обработчик в `setup_logging`.
- Для тестов всегда используется мок Sentry, чтобы не засорять боевой сервис.

---

**Следуйте этим инструкциям для быстрой отладки, мониторинга и расследования инцидентов в любой среде!**
