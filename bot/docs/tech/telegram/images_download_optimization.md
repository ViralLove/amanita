# üñºÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ Telegram Bot

## üìã –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ Telegram Bot Amanita. –û–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é TTL-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è, —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è HTTP-—Å–µ—Å—Å–∏—è–º–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

### **–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ö–∞–∂–¥—ã–π `ImageService` —Å–æ–∑–¥–∞–≤–∞–ª —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é HTTP-—Å–µ—Å—Å–∏—é
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

### **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã:**
- **Overhead —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: ~50-100ms –Ω–∞ –∑–∞–ø—Ä–æ—Å
- **Memory usage**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Ç—Ä–µ–±–ª—è—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–∞–º—è—Ç—å
- **DNS resolution**: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥ –¥–æ–º–µ–Ω–æ–≤
- **TCP handshake**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### **1. SessionManager (Singleton Pattern)**

#### **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP-—Å–µ—Å—Å–∏—è–º–∏ —á–µ—Ä–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω Singleton, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–µ–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –≤—Å–µ–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ `ImageService`.

#### **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ Singleton:**
```python
class SessionManager:
    _instance: Optional['SessionManager'] = None
    _session: Optional[aiohttp.ClientSession] = None
```

**–ü–æ—á–µ–º—É Singleton, –∞ –Ω–µ Dependency Injection:**
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –≤—Å–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **Thread-safety**: –í –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- **Lazy initialization**: –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã:**
1. **–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è**: ‚ùå –ù–µ thread-safe, —Å–ª–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å
2. **Dependency Injection**: ‚ùå –¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
3. **httpx.AsyncClient**: ‚ùå –î—Ä—É–≥–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –±–æ–ª—å—à–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **asyncio.create_task**: ‚ùå –°–ª–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º

#### **Connection Pooling Configuration:**
```python
connector = aiohttp.TCPConnector(
    limit=100,              # –û–±—â–∏–π –ª–∏–º–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    limit_per_host=30,      # –õ–∏–º–∏—Ç –Ω–∞ –æ–¥–∏–Ω —Ö–æ—Å—Ç
    keepalive_timeout=30,   # Keep-alive timeout
    enable_cleanup_closed=True,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
    use_dns_cache=True,     # DNS –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    ttl_dns_cache=300       # TTL DNS –∫—ç—à–∞ (5 –º–∏–Ω—É—Ç)
)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
- **limit=100**: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è Telegram Bot (–Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, –Ω–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ)
- **limit_per_host=30**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç DDoS –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
- **keepalive_timeout=30**: –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤
- **DNS caching**: –£—Å–∫–æ—Ä—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ —Ç–µ–º –∂–µ –¥–æ–º–µ–Ω–∞–º

### **2. TTL-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**

#### **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–î–∏—Å–∫–æ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–≤–µ–∂–µ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞ (mtime) –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º TTL.

#### **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –∫—ç—à–∞:**
- **Memory efficiency**: –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ RAM
- **Persistence**: –ö—ç—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- **Scalability**: –ú–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Ç—ã—Å—è—á–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Cost-effective**: –î–µ—à–µ–≤–ª–µ —á–µ–º in-memory –∫—ç—à

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—ç—à–∞:**
```
image_cache/
‚îú‚îÄ‚îÄ {md5_hash_url_1}.jpg
‚îú‚îÄ‚îÄ {md5_hash_url_2}.png
‚îî‚îÄ‚îÄ {md5_hash_url_3}.webp
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ MD5 —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
- **URL normalization**: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ URL –¥–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ö–µ—à
- **File naming**: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤
- **Collision resistance**: –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Performance**: –ë—ã—Å—Ç—Ä–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ

#### **TTL –ª–æ–≥–∏–∫–∞:**
```python
def _is_cache_fresh(self, path: str) -> bool:
    mtime = os.path.getmtime(path)
    age = time.time() - mtime
    return age <= self.config.cache_duration
```

**–ü–æ—á–µ–º—É mtime, –∞ –Ω–µ ETag/Last-Modified:**
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
- **Performance**: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- **Consistency**: –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### **3. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

#### **Graceful Degradation:**
```python
try:
    media_group = await self.create_media_group(product, images, loc)
    await message.answer_media_group(media_group)
except Exception as e:
    # Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    caption = self._create_product_caption(product, loc)
    await message.answer(f"{caption}\n\n‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- **User Experience**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **Reliability**: –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- **Debugging**: –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **Graceful degradation**: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç, –Ω–æ –Ω–µ –ø–∞–¥–∞–µ—Ç

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### **–ö–ª–∞—Å—Å SessionManager**

```python
class SessionManager:
    """–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP-—Å–µ—Å—Å–∏—è–º–∏."""
    
    async def get_session(self, config: Optional[ImageServiceConfig] = None) -> aiohttp.ClientSession:
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç HTTP-—Å–µ—Å—Å–∏—é —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏."""
        
    async def close_session(self) -> None:
        """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é HTTP-—Å–µ—Å—Å–∏—é."""
        
    async def cleanup(self) -> None:
        """–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–µ—Å—Å–∏–π."""
```

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ImageService**

```python
class ImageService(IImageService):
    def __init__(self, config: Optional[ImageServiceConfig] = None):
        self.session_manager = SessionManager()  # Singleton instance
        
    async def __aenter__(self):
        self.session = await self.session_manager.get_session(self.config)
        return self
        
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        # –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é - –æ–Ω–∞ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        self.session = None
```

### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ download_image**

```python
async def download_image(self, url: str, product_id: str) -> str:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å —É—á–µ—Ç–æ–º —Å–≤–µ–∂–µ—Å—Ç–∏
    if self.config.enable_cache:
        cached_path = self.get_cached(url)
        if cached_path is not None:
            return cached_path  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ–∂–∏–π –∫—ç—à
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –∫—ç—à –Ω–µ–∞–∫—Ç—É–∞–ª–µ–Ω
    temp_path = await self._download_image_internal(url, product_id)
    
    # –ö—ç—à–∏—Ä—É–µ–º –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    if self.config.enable_cache:
        cache_path = self.config.get_cache_file_path(url)
        shutil.copy2(temp_path, cache_path)
    
    return temp_path
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- **–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏**: ~50-100ms
- **Memory per session**: ~2-5MB
- **DNS resolution**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- **TCP handshake**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å

### **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- **–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏**: ~1-5ms (–∏–∑ –∫—ç—à–∞)
- **Memory per session**: ~2-5MB (–æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è)
- **DNS resolution**: –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç
- **TCP handshake**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

### **–û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **Latency**: 20-40% —Å–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏
- **Throughput**: 3-5x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- **Resource usage**: 60-80% —Å–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- **Reliability**: –£–ª—É—á—à–µ–Ω–∏–µ uptime –∑–∞ —Å—á–µ—Ç graceful degradation

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Unit —Ç–µ—Å—Ç—ã:**
```python
async def test_session_manager():
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Singleton pattern
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
```

### **Integration —Ç–µ—Å—Ç—ã:**
```python
async def test_image_service_with_session_manager():
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ImageService —Å SessionManager
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
```

### **Performance —Ç–µ—Å—Ç—ã:**
- **Concurrent requests**: –î–æ 100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Memory usage**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- **Response time**: –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

### **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
1. –°–æ–∑–¥–∞–Ω–∏–µ `SessionManager` (Singleton)
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `ImageService` —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä
3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∫—ç—à–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### **–†–∞–±–æ—Ç–∞:**
1. `ImageService` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é —É `SessionManager`
2. `SessionManager` —Å–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫—ç—à–∞
4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:**
1. `ImageService` –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ—Å—Å–∏—é
2. `SessionManager` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏—é –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏:**
- **Timeout**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff
- **Connection refused**: Graceful degradation
- **DNS resolution failed**: Fallback –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### **–§–∞–π–ª–æ–≤—ã–µ –æ—à–∏–±–∫–∏:**
- **Disk full**: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –∫—ç—à–∞
- **Permission denied**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ fallback
- **Corrupted cache**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### **Graceful degradation:**
```python
# –ü—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
if self.config.show_error_placeholders:
    caption = self._create_product_caption(product, loc)
    await message.answer(
        f"{caption}\n\n‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
        parse_mode="HTML"
    )
```

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏):**
- **Metrics collection**: Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **Cache warming**: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Compression**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (1-2 –º–µ—Å—è—Ü–∞):**
- **Distributed caching**: Redis –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- **CDN integration**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CDN –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Image optimization**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞

### **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (3-6 –º–µ—Å—è—Ü–µ–≤):**
- **Machine learning**: –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Adaptive TTL**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TTL –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
- **Multi-region**: –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìö –°—Å—ã–ª–∫–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã

### **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [aiohttp Documentation](https://docs.aiohttp.org/)
- [Python asyncio](https://docs.python.org/3/library/asyncio.html)
- [HTTP Connection Pooling](https://tools.ietf.org/html/rfc7230#section-6.3)

### **–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- [Singleton Pattern](https://en.wikipedia.org/wiki/Singleton_pattern)
- [Connection Pooling](https://en.wikipedia.org/wiki/Connection_pool)
- [Graceful Degradation](https://en.wikipedia.org/wiki/Graceful_degradation)

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
- [httpx](https://www.python-httpx.org/) - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ aiohttp
- [aioredis](https://aioredis.readthedocs.io/) - Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [Pillow](https://pillow.readthedocs.io/) - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

1. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ TTL-–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Graceful degradation –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

–†–µ—à–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ Telegram Bot —Å –≤—ã—Å–æ–∫–∏–º —Ç—Ä–∞—Ñ–∏–∫–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è AI-–º–æ–¥–µ–ª–µ–π –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ Telegram Bot Amanita.*
