# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ Telegram –±–æ—Ç–µ Amanita

## üìã **–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã**

–ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ Telegram –±–æ—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- **–í–∞–ª–∏–¥–∞—Ü–∏—é** —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É ValidationFactory
- **–•—Ä–∞–Ω–µ–Ω–∏–µ** –≤ IPFS (Pinata/Arweave) —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é** —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ** –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é** —á–µ—Ä–µ–∑ callback-–∫–Ω–æ–ø–∫–∏

## üéØ **–ö–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è**

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤**
- **–°–æ–æ–±—â–µ–Ω–∏–µ 1**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (caption –¥–æ 1024 —Å–∏–º–≤–æ–ª–æ–≤)
- **–°–æ–æ–±—â–µ–Ω–∏–µ 2**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª–∏–Ω—ã
- **–ï–¥–∏–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞**: –ö–Ω–æ–ø–∫–∏ "–í –∫–æ—Ä–∑–∏–Ω—É" –∏ "–ö –∫–∞—Ç–∞–ª–æ–≥—É" –¥–ª—è –æ–±–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ß–∏—Å—Ç—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç**: –û–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

## üèóÔ∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–ª–æ–∏**

### 1. **Telegram Bot Layer** (`bot/handlers/catalog.py`)

```python
@router.callback_query(F.data == "menu:catalog")
async def show_catalog(callback: CallbackQuery):
    # 1. –ü–æ–ª—É—á–∞–µ–º user_id –∏ —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # 2. –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —á–µ—Ä–µ–∑ ProductRegistryService (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
    # 3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
    # 4. –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
```

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Router**: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
- **Localization**: –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (ru/en)
- **UserSettings**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **ProductRegistryService**: –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
- **Two-Level Display**: –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
```python
@router.callback_query(F.data == "scroll:catalog")
async def scroll_to_catalog(callback: CallbackQuery):
    # –£–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ –Ω–∞—á–∞–ª—É –∫–∞—Ç–∞–ª–æ–≥–∞

@router.callback_query(F.data.startswith("product:details:"))
async def show_product_details(callback: CallbackQuery):
    # –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
```

### 2. **Service Layer** (`bot/services/product/`)

#### **ProductRegistryService** - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
```python
class ProductRegistryService:
    def __init__(self, 
                 blockchain_service: BlockchainService,
                 storage_service: ProductStorageService,
                 validation_service: ProductValidationService,
                 account_service: AccountService):
        self.cache_service = ProductCacheService()
        self.metadata_service = ProductMetadataService(storage_service)
        self.formatter_service = ProductFormatterService()
```

**–°–µ—Ä–≤–∏—Å—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```python
class ProductFormatterService:
    def format_product_main_info_for_telegram(self, product: Product, loc: Localization) -> str:
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è caption –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        
    def format_product_description_for_telegram(self, product: Product, loc: Localization) -> str:
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `async def get_all_products() -> List[Product]` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- `async def get_product(product_id) -> Product` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
- `async def create_product(product_data) -> dict` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
```python
CACHE_TTL = {
    'catalog': timedelta(minutes=5),      # –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    'description': timedelta(hours=24),   # –û–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    'image': timedelta(hours=12)          # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
}
```

#### **ProductCacheService** - –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
class ProductCacheService:
    def __init__(self):
        self.catalog_cache: Dict = {}      # {"version": int, "products": List[Product], "timestamp": datetime}
        self.description_cache: Dict[str, Tuple[Description, datetime]] = {}
        self.image_cache: Dict[str, Tuple[str, datetime]] = {}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞:**
```python
def _validate_cached_data(self, data: Any, data_type: str) -> ValidationResult:
    if data_type == 'catalog':
        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–∞
        if isinstance(data, dict) and 'version' in data and 'products' in data:
            return ValidationResult.success()
        else:
            return ValidationResult.failure("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–∞")
```

#### **ProductStorageService** - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
```python
class ProductStorageService:
    def __init__(self, storage_provider=None):
        self.communication_type = STORAGE_COMMUNICATION_TYPE  # sync/async/hybrid
        self.ipfs = IPFSFactory().get_storage()
```

**–†–µ–∂–∏–º—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏:**
- **`sync`**: –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã –¥–ª—è Pinata, –º–æ–∫–æ–≤
- **`async`**: –ß–µ—Ä–µ–∑ `asyncio.run()` –¥–ª—è Arweave
- **`hybrid`**: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥

**–ú–µ—Ç–æ–¥ `download_json`:**
```python
def download_json(self, cid: str) -> Optional[Dict[str, Any]]:
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ç–∏–ø—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ —Ä–µ–∂–∏–º—É –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
    if self.communication_type == "sync":
        if hasattr(self.ipfs, 'download_json'):
            return self.ipfs.download_json(cid)  # –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤
        else:
            return asyncio.run(self.ipfs.download_json_async(cid))  # Fallback
```

### 3. **Storage Layer** (`bot/services/core/storage/`)

#### **IPFSFactory** - –§–∞–±—Ä–∏–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
```python
class IPFSFactory:
    def __init__(self):
        self.set_storage(STORAGE_TYPE)  # pinata/arweave
        
    def set_storage(self, storage_type: str):
        if storage_type.lower() == 'pinata':
            self.storage = SecurePinataUploader()
        elif storage_type.lower() == 'arweave':
            self.storage = ArWeaveUploader()
```

#### **SecurePinataUploader** - –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
```python
def download_json(self, cid: str) -> Optional[Dict]:
    url = f"{self.gateway_url}/{cid}"
    response = self._make_request('GET', url)
    return response.json()
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã** - –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **Rate limiting** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- **Gateway URLs** - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ CID –≤ HTTP URL

### 4. **Validation Layer** (`bot/validation/`)

#### **ValidationFactory** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
```python
class ValidationFactory:
    @classmethod
    def get_product_validator(cls) -> ProductValidator:
        if cls._product_validator is None:
            cls._product_validator = ProductValidator()
        return cls._product_validator
```

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã:**
- `CIDValidator` - –≤–∞–ª–∏–¥–∞—Ü–∏—è IPFS CID
- `ProductValidator` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–¥—É–∫—Ç–∞
- `PriceValidator` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω
- `ProportionValidator` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π

#### **ProductValidator** - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤
```python
class ProductValidator(ValidationRule[Dict[str, Any]]):
    def validate(self, value: Dict[str, Any]) -> ValidationResult:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        required_fields = ['business_id', 'title', 'cover_image_url', 'species', 'organic_components']
        for field in required_fields:
            if field not in value:
                return ValidationResult.failure(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: {field}")
```

### 5. **Blockchain Layer** (`bot/services/core/blockchain.py`)

#### **BlockchainService** - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º–∏
```python
class BlockchainService:
    def get_catalog_version(self) -> int:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞"""
        return self._call_contract_read_function(
            "ProductRegistry", "getMyCatalogVersion", 0
        )
    
    def get_all_products(self) -> List[dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞"""
        product_ids = self._call_contract_read_function(
            "ProductRegistry", "getAllActiveProductIds", []
        )
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
        products = []
        for product_id in product_ids:
            product = self._call_contract_read_function(
                "ProductRegistry", "getProduct", None, product_id
            )
            if product:
                products.append(product)
        return products
```

## üîÑ **–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞**

### **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:**
```python
# bot/main.py
async def preload_catalog():
    await product_registry_service.get_all_products()
    logger.info("–§–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

asyncio.create_task(preload_catalog())
```

### **–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫–∞—Ç–∞–ª–æ–≥–∞:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞** - `cache_service.get_cached_item("catalog", "catalog")`
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `blockchain_service.get_catalog_version()`
3. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –±–ª–æ–∫—á–µ–π–Ω–∞** (–µ—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª)
4. **–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤** - `_deserialize_product()`
5. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞** - `cache_service.set_cached_item()`
6. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π** - –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

### **–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞** - `product_registry_service.get_all_products()`
2. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏** - `formatter_service.format_product_main_info_for_telegram()`
3. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è** - `formatter_service.format_product_description_for_telegram()`
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** - `answer_photo` —Å caption –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
5. **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è** - `answer` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏ —Ç–æ–π –∂–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π

### **–ü—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:**
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö** - `storage_service.download_json(ipfs_cid)`
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - `validation_service.validate_product_data()`
3. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ Product** - `Product.from_dict()`

## üé® **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**

### **üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

#### **ProductFormatterService** - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```python
class ProductFormatterService(IProductFormatter):
    def __init__(self, config: Optional[ProductFormatterConfig] = None):
        self.config = config or ProductFormatterConfig()
        self.logger = logging.getLogger(__name__)
```

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ `ProductFormatterConfig`
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π** —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º —Ç—Ä–µ–∫–∏–Ω–≥–æ–º
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
- **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### **ProductFormatterConfig** - –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```python
@dataclass
class ProductFormatterConfig:
    max_text_length: int = 4000
    enable_emoji: bool = True
    enable_html: bool = True
    truncate_text: bool = True
    
    emoji_mapping: Dict[str, str] = {
        'product': 'üè∑Ô∏è', 'species': 'üåø', 'status_available': '‚úÖ',
        'composition': 'üî¨', 'pricing': 'üí∞', 'details': 'üìã',
        'shamanic': 'üßô‚Äç‚ôÇÔ∏è', 'warnings': '‚ö†Ô∏è', 'dosage': 'üíä'
    }
    
    text_templates: Dict[str, str] = {
        'truncate_indicator': '... <i>–¢–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω –¥–ª—è Telegram</i>',
        'section_separator': '\n', 'component_separator': '\n'
    }
```

### **üì± –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤**

#### **–£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (Caption)**
```python
def format_product_main_info_for_telegram(product, loc: Localization) -> str:
    # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è caption –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 1024 —Å–∏–º–≤–æ–ª–æ–≤)
    # –í–∫–ª—é—á–∞–µ—Ç: –Ω–∞–∑–≤–∞–Ω–∏–µ, –≤–∏–¥, —Å—Ç–∞—Ç—É—Å, –Ω–∞—É—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–æ—Å—Ç–∞–≤, —Ü–µ–Ω—ã, —Ñ–æ—Ä–º—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    return main_info_text
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**
- **üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞** - —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **üåø –í–∏–¥ –ø—Ä–æ–¥—É–∫—Ç–∞** - –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —á—Ç–æ —ç—Ç–æ
- **‚úÖ –°—Ç–∞—Ç—É—Å** - –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
- **üî¨ –ù–∞—É—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ** - –¥–ª—è —Ç–æ—á–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **üî¨ –°–æ—Å—Ç–∞–≤** - –±–∞–∑–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **üí∞ –¶–µ–Ω—ã** - —Å –≤–∞–ª—é—Ç–∞–º–∏ –∏ –≤–µ—Å–∞–º–∏
- **üì¶ –§–æ—Ä–º—ã** - –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
- **üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏** - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞

#### **–£—Ä–æ–≤–µ–Ω—å 2: –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**
```python
def format_product_description_for_telegram(product, loc: Localization) -> str:
    # –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª–∏–Ω—ã, –ø–æ–ª–Ω—ã–π –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    # –í–∫–ª—é—á–∞–µ—Ç: –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —ç—Ñ—Ñ–µ–∫—Ç—ã, —à–∞–º–∞–Ω—Å–∫–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞, –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è
    return description_text
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**
- **üî¨ –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- **üìñ –û–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** - –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- **‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã** - –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–º
- **üßô‚Äç‚ôÇÔ∏è –®–∞–º–∞–Ω—Å–∫–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞** - —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
- **‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è** - –≤–∞–∂–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è
- **üíä –î–æ–∑–∏—Ä–æ–≤–∫–∞** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é
- **üåü –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞

### **‚ö° –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞**

#### **–ü—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞**
```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
progress_message = await callback.message.answer(
    f"üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥: 0/{len(products)} –ø—Ä–æ–¥—É–∫—Ç–æ–≤...\n\n"
    f"üîç <b>–ù–∞–≤–∏–≥–∞—Ü–∏—è:</b> #catalog"
)

# –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
for i, product in enumerate(products):
    # ... –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ ...
    await progress_message.edit_text(f"üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥: {i+1}/{len(products)} –ø—Ä–æ–¥—É–∫—Ç–æ–≤...")

# –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ
await progress_message.delete()
await callback.message.answer(f"‚úÖ –ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω! –í—Å–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: {len(products)}")
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞:**
- **–†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è** - —Ö—ç—à—Ç–µ–≥–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- **–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** - —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–¥—É–∫—Ç–∞**
```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
loading_message = await callback.message.answer(loc.t("catalog.loading"))

# ... –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ...

# –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
await loading_message.delete()
```

### **üéØ –£–º–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è**

#### **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã**
```python
# –ö–∞—Ç–∞–ª–æ–≥: –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
def get_product_keyboard(product_id: str, loc: Localization) -> InlineKeyboardMarkup:
    keyboard = [
        [
            InlineKeyboardButton(text="üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ", callback_data=f"product:details:{product_id}"),
            InlineKeyboardButton(text="üõí –í –∫–æ—Ä–∑–∏–Ω—É", callback_data=f"product:cart:{product_id}")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä: —É–º–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
def get_product_details_keyboard_with_scroll(product_id: str, loc: Localization) -> InlineKeyboardMarkup:
    keyboard = [
        [
            InlineKeyboardButton(text="üõí –í –∫–æ—Ä–∑–∏–Ω—É", callback_data=f"product:cart:{product_id}"),
            InlineKeyboardButton(text="üîô –ö –∫–∞—Ç–∞–ª–æ–≥—É", callback_data="scroll:catalog")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:**
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è** - —Ä–∞–∑–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
- **–£–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª** - `scroll:catalog` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ–±–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–¥—É–∫—Ç–∞
- **–ú–∏–Ω–∏–º–∞–ª–∏–∑–º** - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

#### **–£–º–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ö—ç—à—Ç–µ–≥–∏**
```python
@router.callback_query(F.data == "scroll:catalog")
async def scroll_to_catalog(callback: CallbackQuery):
    scroll_message = (
        f"üìö <b>–ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</b>\n\n"
        f"‚Ä¢ #catalog - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ç–∞–ª–æ–≥\n"
        f"üí° <i>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ö—ç—à—Ç–µ–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –Ω—É–∂–Ω–æ–º—É —Ä–∞–∑–¥–µ–ª—É</i>"
    )
    await callback.message.answer(scroll_message, parse_mode="HTML")
```

### **üîÑ –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

#### **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
```python
try:
    formatted_sections = formatter_service.format_product_for_telegram(product, loc)
    product_text = (
        formatted_sections['main_info'] +
        formatted_sections['composition'] +
        formatted_sections['pricing'] +
        formatted_sections['details']
    )
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
    # Fallback —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    product_text = f"üè∑Ô∏è <b>{getattr(product, 'title', '–ü—Ä–æ–¥—É–∫—Ç')}</b>\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"
```

#### **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
```python
if product.cover_image_url:
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        image_url = storage_service.get_public_url(product.cover_image_url)
        async with aiohttp.ClientSession() as session:
            async with session.get(image_url) as response:
                if response.status == 200:
                    # –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    await callback.message.answer_photo(FSInputFile(image_path), caption=product_text)
                else:
                    # Fallback: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
                    await callback.message.answer(product_text, reply_markup=keyboard)
    except Exception as e:
        # Fallback: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        await callback.message.answer(product_text, reply_markup=keyboard)
else:
    # –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
    await callback.message.answer(product_text, reply_markup=keyboard)
```

### **üìè –£–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞**

#### **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –¥–ª—è Telegram**
```python
# –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è Telegram
original_length = len(product_text)
product_text = formatter_service._truncate_text(product_text)
final_length = len(product_text)

if original_length != final_length:
    logger.info(f"–¢–µ–∫—Å—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ –æ–±—Ä–µ–∑–∞–Ω: {original_length} -> {final_length} —Å–∏–º–≤–æ–ª–æ–≤")
```

#### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**
```python
def should_truncate(self, text: str) -> bool:
    return self.truncate_text and len(text) > self.max_text_length

def _truncate_text(self, text: str) -> str:
    if not self.config.should_truncate(text):
        return text
    
    # –û–±—Ä–µ–∑–∞–µ–º —Å —É—á–µ—Ç–æ–º HTML —Ç–µ–≥–æ–≤
    truncated = text[:self.config.max_text_length - len(self.config.get_template('truncate_indicator'))]
    return truncated + self.config.get_template('truncate_indicator')
```

### **üåê –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**

#### **–õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
```python
# –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_id = callback.from_user.id
lang = user_settings.get_language(user_id)
loc = Localization(lang)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
await callback.message.answer(loc.t("catalog.loading"))
await callback.message.answer(loc.t("catalog.empty"))
```

#### **–õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤**
```python
if product.status == 1:
    status_emoji = self.config.get_emoji('status_available')
    status_text = loc.t('catalog.product.available_for_order')
else:
    status_emoji = self.config.get_emoji('status_unavailable')
    status_text = loc.t('catalog.product.temporarily_unavailable')
```

### **üé® –í–∏–∑—É–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**

#### **–≠–º–æ–¥–∑–∏-–Ω–∞–≤–∏–≥–∞—Ü–∏—è**
- **üè∑Ô∏è –ü—Ä–æ–¥—É–∫—Ç—ã** - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
- **üåø –í–∏–¥—ã** - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É
- **‚úÖ –°—Ç–∞—Ç—É—Å—ã** - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞–∫–∞–∑–∞
- **üí∞ –¶–µ–Ω—ã** - —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **üî¨ –°–æ—Å—Ç–∞–≤** - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- **üßô‚Äç‚ôÇÔ∏è –®–∞–º–∞–Ω—Å–∫–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞** - —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

#### **–í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏**
```python
# –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ)
if i < len(products) - 1:
    await callback.message.answer("‚òÄÔ∏è" * 8)
```

#### **HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
await callback.message.answer_photo(
    FSInputFile(image_path),
    caption=product_text,
    parse_mode="HTML",
    reply_markup=keyboard
)
```

### **‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

#### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
- **–ö—ç—à –ø—Ä–æ–¥—É–∫—Ç–æ–≤** - –∏–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ö—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π
- **–ö—ç—à –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤

#### **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**
```python
# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
async with aiohttp.ClientSession() as session:
    async with session.get(image_url) as response:
        if response.status == 200:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
            with tempfile.NamedTemporaryFile(delete=False, suffix=".jpg") as tmp_file:
                tmp_file.write(await response.read())
```

#### **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤**
```python
# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
os.unlink(image_path)

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
await loading_message.delete()
await progress_message.delete()
```

## üîß **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
# .env
STORAGE_TYPE=pinata                    # pinata/arweave
STORAGE_COMMUNICATION_TYPE=sync        # sync/async/hybrid
PINATA_API_KEY=your_pinata_key
PINATA_SECRET_KEY=your_pinata_secret
ARWEAVE_PRIVATE_KEY=your_arweave_key
```

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
```python
# bot/config.py
LOG_LEVEL = "INFO"
LOG_FILE = "logs/amanita_api.log"
LOG_MAX_SIZE = 10 * 1024 * 1024  # 10MB
LOG_BACKUP_COUNT = 5
```

## üìä **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞:**
- **–ö–∞—Ç–∞–ª–æ–≥**: 5 –º–∏–Ω—É—Ç (—á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
- **–û–ø–∏—Å–∞–Ω–∏—è**: 24 —á–∞—Å–∞ (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**: 12 —á–∞—Å–æ–≤ (–º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç)

### **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
1. **–§–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
2. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ –ø–∞–º—è—Ç–∏
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–π** –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
4. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏** —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏

## üö® **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

### **–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**
- **StorageError** - –ø—Ä–æ–±–ª–µ–º—ã —Å IPFS/Arweave
- **ValidationError** - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **BlockchainError** - –ø—Ä–æ–±–ª–µ–º—ã —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º
- **CacheError** - –ø—Ä–æ–±–ª–µ–º—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:**
1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
2. **Fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã**
3. **–û—á–∏—Å—Ç–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞**
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫** –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üîÆ **–ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è**

### **–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫** –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–≥—Ä–∏–±—ã, —Ç—Ä–∞–≤—ã, –¥–æ–±–∞–≤–∫–∏)
2. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤
3. **–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º** —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –∫—ç—à–µ–º
4. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏ –∞–∫—Ü–∏—è—Ö

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **Redis –∫—ç—à** –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
2. **CDN** –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
3. **WebSocket** –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
4. **GraphQL** –¥–ª—è –≥–∏–±–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
5. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üìã **–ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

### **–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
1. **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
2. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
4. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö
5. **–ë–ª–æ–∫—á–µ–π–Ω-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
1. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è
5. **UX-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞