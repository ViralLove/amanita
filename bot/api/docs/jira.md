# User Story: API для обновления продуктов

## Epic: E-commerce Integration API
**Epic ID:** EPIC-001  
**Epic Description:** Полная интеграция WordPress/WooCommerce с Python микросервисом AMANITA через REST API

---

## User Story: Обновление продуктов через API

### US-002: Как продавец e-commerce системы, я хочу иметь возможность обновлять данные существующих продуктов через API, чтобы поддерживать актуальность каталога без необходимости полной перезаписи продукта

**Story ID:** US-002  
**Priority:** High  
**Story Points:** 8  
**Sprint:** Sprint 3  
**Assignee:** Backend Team  
**QA:** QA Team  

### Описание
В настоящее время API поддерживает только создание продуктов через `/products/upload`, но не предоставляет возможности обновления существующих продуктов. Продавцы e-commerce систем нуждаются в возможности:
- Обновлять отдельные поля продукта (цены, описание, изображения)
- Изменять статус активности продукта
- Модифицировать доступность и метаданные
- Выполнять частичные обновления без необходимости передачи всех данных

### Критерии приемки (Acceptance Criteria)

#### AC-002.1: Обновление продукта по ID
- **Given** продавец имеет существующий продукт с ID в системе
- **When** продавец отправляет PUT-запрос на `/products/{id}` с обновленными данными
- **Then** система обновляет продукт и возвращает статус успеха с обновленными данными
- **And** система валидирует входные данные по тем же правилам, что и при создании
- **And** система логирует операцию обновления

#### AC-002.2: Частичное обновление продукта
- **Given** продавец хочет обновить только определенные поля продукта
- **When** продавец отправляет PATCH-запрос на `/products/{id}` с частичными данными
- **Then** система обновляет только переданные поля, сохраняя остальные неизменными
- **And** система возвращает полные обновленные данные продукта

#### AC-002.3: Обновление статуса активности
- **Given** продавец хочет изменить статус активности продукта
- **When** продавец отправляет POST-запрос на `/products/{id}/status` с новым статусом
- **Then** система обновляет статус продукта в блокчейне
- **And** система возвращает подтверждение с новым статусом

#### AC-002.4: Обновление цен и доступности
- **Given** продавец хочет изменить цены или доступность продукта
- **When** продавец отправляет PATCH-запрос на `/products/{id}/pricing` с новыми ценами
- **Then** система обновляет цены и перезаписывает метаданные в IPFS
- **And** система возвращает обновленные данные о ценах

#### AC-002.5: Обновление метаданных и изображений
- **Given** продавец хочет обновить описание или изображения продукта
- **When** продавец отправляет PATCH-запрос на `/products/{id}/metadata` с новыми данными
- **Then** система загружает новые метаданные в IPFS
- **And** система обновляет ссылки на изображения
- **And** система возвращает новые CID для метаданных

#### AC-002.6: Обработка ошибок при обновлении
- **Given** продавец отправляет некорректные данные для обновления
- **When** система не может выполнить обновление
- **Then** система возвращает HTTP 4xx с детальным описанием ошибки
- **And** система логирует ошибку для дальнейшего анализа

#### AC-002.7: Идемпотентность операций обновления
- **Given** продавец отправляет одинаковый запрос на обновление несколько раз
- **When** система обрабатывает повторные запросы
- **Then** система возвращает одинаковый результат без создания дубликатов
- **And** система не выполняет лишних операций в блокчейне

#### AC-002.8: Аутентификация и авторизация
- **Given** запрос на обновление продукта
- **When** система проверяет права доступа
- **Then** система разрешает обновление только владельцу продукта
- **And** система использует HMAC/Bearer аутентификацию

### Определение готовности (Definition of Ready)
- [ ] Требования к API четко определены и задокументированы
- [ ] Дизайн эндпойнтов согласован с архитектурной командой
- [ ] Тестовые сценарии подготовлены QA командой
- [ ] Моки и фикстуры для тестирования готовы
- [ ] Документация API обновлена

### Определение завершенности (Definition of Done)
- [ ] Все критерии приемки выполнены
- [ ] Код покрыт unit-тестами (минимум 90%)
- [ ] Интеграционные тесты написаны и проходят
- [ ] API документация обновлена
- [ ] Код прошел code review
- [ ] Тестирование в staging-окружении завершено
- [ ] Документация для интеграторов обновлена

---

## Технические субтаски (MVP для запуска первых магазинов)

### TASK-002.1: Создание базовой структуры эндпойнтов обновления
**Task ID:** TASK-002.1  
**Story:** US-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 4  
**Dependencies:** None  

**Описание:**  
Создать базовую структуру эндпойнтов для обновления продуктов в `bot/api/routes/products.py`. Определить Pydantic модели для запросов обновления, создать заглушки эндпойнтов с базовой валидацией и обработкой ошибок.

**Технические инструкции:**
- Добавить новые Pydantic модели: `ProductUpdateRequest`, `ProductStatusUpdateRequest`
- Создать эндпойнты: `PUT /products/{id}`, `POST /products/{id}/status`
- Реализовать базовую валидацию входных данных
- Добавить обработку ошибок 404 (продукт не найден), 403 (нет прав), 400 (некорректные данные)
- Интегрировать с существующей системой логирования

### TASK-002.2: Реализация полного обновления продукта (PUT)
**Task ID:** TASK-002.2  
**Story:** US-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 8  
**Dependencies:** TASK-002.1  

**Описание:**  
Реализовать логику полного обновления продукта через PUT-эндпойнт. Интегрировать с существующим сервисным слоем, добавить проверку существования продукта и валидацию прав доступа.

**Технические инструкции:**
- Создать метод `update_product` в `ProductRegistryService`
- Реализовать проверку существования продукта по ID
- Добавить валидацию прав доступа (только владелец может обновлять)
- Интегрировать с существующей валидацией данных
- Реализовать обновление метаданных в IPFS
- Добавить обновление записи в блокчейне
- Обеспечить атомарность операции (все или ничего)
- Добавить детальное логирование всех этапов обновления

### TASK-002.3: Реализация обновления статуса активности
**Task ID:** TASK-002.3  
**Story:** US-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 4  
**Dependencies:** TASK-002.1  

**Описание:**  
Реализовать специализированный эндпойнт для изменения статуса активности продукта. Обеспечить быструю операцию без необходимости обновления всех метаданных.

**Технические инструкции:**
- Создать метод `update_product_status` в API слое
- Интегрировать с существующим `update_product_status` в `ProductRegistryService`
- Добавить валидацию статусов (активен/неактивен)
- Реализовать быструю операцию в блокчейне без обновления IPFS
- Добавить проверку прав доступа
- Обеспечить идемпотентность операции

### TASK-002.4: Создание unit-тестов для MVP эндпойнтов
**Task ID:** TASK-002.4  
**Story:** US-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 6  
**Dependencies:** TASK-002.2, TASK-002.3  

**Описание:**  
Создать unit-тесты для MVP эндпойнтов обновления продукта. Покрыть основные сценарии успешного выполнения и обработки ошибок.

**Технические инструкции:**
- Использовать существующий файл `test_products_unit.py` (там уже тестируется создание продукта и можно использовать готовую инфраструктуру расширяя ее покрытием нового функционала всей этой user story)
- Реализовать тесты для обновления продукта
- Реализовать тесты для обновления статуса
- Добавить тесты для валидации входных данных при обновлении продукта и обновлении статуса
- Реализовать тесты для обработки ошибок (404, 403, 400, 500) в контексте обновления продукта и статуса
- Обеспечить покрытие кода минимум 88%

### TASK-002.5: Обновление API документации для MVP
**Task ID:** TASK-002.5  
**Story:** US-002  
**Priority:** Critical (MVP)  
**Estimated Hours:** 3  
**Dependencies:** TASK-002.2, TASK-002.3  

**Описание:**  
Обновить API документацию для включения MVP эндпойнтов обновления продукта. Добавить примеры запросов, ответов и кодов ошибок.

**Технические инструкции:**
- Обновить `bot/api/docs/API Docs.md` с MVP эндпойнтами
- Добавить раздел "Обновление продуктов (MVP)" с описанием PUT и status эндпойнтов
- Создать примеры JSON-запросов для полного обновления и смены статуса
- Добавить примеры успешных ответов и кодов ошибок
- Добавить примеры использования с curl-командами
- Обновить раздел "Как использовать API" с примерами обновления

---

## Отложенные задачи (для следующих спринтов)

### TASK-002.6: Реализация частичного обновления продукта (PATCH)
**Task ID:** TASK-002.6  
**Story:** US-002  
**Priority:** Medium  
**Estimated Hours:** 6  
**Dependencies:** TASK-002.2  

**Описание:**  
Реализовать логику частичного обновления продукта через PATCH-эндпойнт. Позволить обновлять только переданные поля, сохраняя остальные данные неизменными.

**Технические инструкции:**
- Создать метод `partial_update_product` в `ProductRegistryService`
- Реализовать логику слияния существующих и новых данных
- Добавить валидацию только обновляемых полей
- Обеспечить оптимизацию: обновлять IPFS только при изменении метаданных
- Реализовать проверку изменений перед выполнением операций
- Добавить поддержку условного обновления (только если данные изменились)

### TASK-002.7: Реализация обновления цен и доступности
**Task ID:** TASK-002.7  
**Story:** US-002  
**Priority:** Medium  
**Estimated Hours:** 6  
**Dependencies:** TASK-002.6  

**Описание:**  
Реализовать специализированный эндпойнт для обновления цен и доступности продукта. Обеспечить валидацию цен и обновление метаданных в IPFS.

**Технические инструкции:**
- Создать метод `update_product_pricing` в API слое
- Реализовать валидацию цен через существующую систему валидации
- Добавить проверку доступности (stock, availability)
- Интегрировать с обновлением метаданных в IPFS
- Обеспечить обновление только цен без изменения других метаданных
- Добавить поддержку batch-обновления цен для нескольких вариантов

### TASK-002.8: Реализация идемпотентности операций
**Task ID:** TASK-002.8  
**Story:** US-002  
**Priority:** High  
**Estimated Hours:** 4  
**Dependencies:** TASK-002.2, TASK-002.3  

**Описание:**  
Обеспечить идемпотентность всех операций обновления продукта. Реализовать механизм предотвращения дублирования операций и повторного выполнения.

**Технические инструкции:**
- Добавить поддержку заголовка `Idempotency-Key` в запросах
- Реализовать кэширование результатов операций по ключу идемпотентности
- Добавить проверку хэша данных для определения изменений
- Реализовать механизм блокировки для предотвращения конкурентных обновлений
- Добавить TTL для кэша идемпотентности (например, 24 часа)
- Обеспечить очистку устаревших ключей идемпотентности

### TASK-002.9: Расширение системы валидации для обновлений
**Task ID:** TASK-002.9  
**Story:** US-002  
**Priority:** Medium  
**Estimated Hours:** 6  
**Dependencies:** TASK-002.1  

**Описание:**  
Расширить существующую систему валидации для поддержки операций обновления. Добавить специфичные правила валидации для частичных обновлений.

**Технические инструкции:**
- Создать метод `validate_product_update` в `ProductValidationService`
- Добавить валидацию для частичных обновлений (только переданные поля)
- Реализовать проверку совместимости обновлений с существующими данными
- Добавить валидацию бизнес-правил для обновлений (например, нельзя изменить ID)
- Интегрировать с существующей системой валидации цен и метаданных
- Добавить поддержку условной валидации (валидировать только измененные поля)

### TASK-002.10: Создание интеграционных тестов
**Task ID:** TASK-002.10  
**Story:** US-002  
**Priority:** Medium  
**Estimated Hours:** 6  
**Dependencies:** TASK-002.4  

**Описание:**  
Создать интеграционные тесты для проверки взаимодействия между API, сервисным слоем и внешними системами (IPFS, блокчейн).

**Технические инструкции:**
- Создать тестовый файл `test_product_update_integration.py`
- Реализовать end-to-end тесты для полного цикла обновления
- Добавить тесты интеграции с IPFS (загрузка/обновление метаданных)
- Реализовать тесты интеграции с блокчейном (обновление статуса)
- Добавить тесты для проверки атомарности операций
- Реализовать тесты для проверки конкурентных обновлений
- Добавить тесты производительности для операций обновления
- Использовать реальные моки для внешних сервисов

### TASK-002.11: Реализация обновления метаданных и изображений
**Task ID:** TASK-002.11  
**Story:** US-002  
**Priority:** Low  
**Estimated Hours:** 8  
**Dependencies:** TASK-002.6  

**Описание:**  
Реализовать специализированный эндпойнт для обновления метаданных и изображений продукта. Интегрировать с существующими эндпойнтами загрузки медиа.

**Технические инструкции:**
- Создать метод `update_product_metadata` в API слое
- Интегрировать с существующими эндпойнтами `/media/upload` и `/description/upload`
- Реализовать обновление описания через загрузку нового JSON в IPFS
- Добавить поддержку обновления галереи изображений
- Обеспечить сохранение ссылок на старые изображения при частичном обновлении
- Реализовать валидацию новых CID перед обновлением

### TASK-002.12: Обновление документации для интеграторов
**Task ID:** TASK-002.12  
**Story:** US-002  
**Priority:** Low  
**Estimated Hours:** 3  
**Dependencies:** TASK-002.5  

**Описание:**  
Создать документацию для интеграторов e-commerce систем по использованию новых эндпойнтов обновления продукта.

**Технические инструкции:**
- Создать раздел "Интеграция обновления продуктов" в документации
- Добавить примеры интеграции с WooCommerce
- Создать руководство по миграции с существующих решений
- Добавить best practices для обновления продуктов
- Создать troubleshooting guide для типичных проблем
- Добавить примеры кода на PHP для WordPress интеграции
- Создать чек-лист для тестирования интеграции обновления

---

## Метрики успеха

### MVP метрики (для запуска первых магазинов)
- [ ] 3 критических критерия приемки выполнены (AC-002.1, AC-002.3, AC-002.6)
- [ ] 85% покрытие тестами MVP эндпойнтов
- [ ] Время отклика API < 3 секунды для операций обновления
- [ ] 0 критических багов в MVP функционале

### Технические метрики MVP
- [ ] Покрытие кода unit-тестами ≥ 85%
- [ ] Время выполнения CI/CD pipeline < 10 минут
- [ ] 0 security vulnerabilities в MVP коде
- [ ] API документация обновлена для MVP эндпойнтов

### Бизнес-метрики MVP
- [ ] MVP API готов для production использования
- [ ] Поддержка базовых операций обновления (полное обновление + статус)
- [ ] Соответствие минимальным требованиям e-commerce интеграции
- [ ] Готовность к запуску первых магазинов-нод

### Полные метрики (после реализации всех задач)
- [ ] Все 8 критериев приемки выполнены
- [ ] 100% покрытие тестами всех эндпойнтов
- [ ] Время отклика API < 2 секунды для всех операций
- [ ] Покрытие кода unit-тестами ≥ 90%
- [ ] Покрытие кода интеграционными тестами ≥ 80%
- [ ] Поддержка всех типов обновлений продуктов
- [ ] Полная документация для интеграторов
