# API Requirements - AMANITA WordPress Integration

## Обзор
Документ описывает функциональные требования к API для интеграции WordPress/WooCommerce плагина с Python микросервисом AMANITA, который управляет блокчейн экосистемой.

## Архитектурный контекст
- **WordPress/WooCommerce** - привычная среда для e-commerce операций
- **Python микросервис** - управляет блокчейн контрактами и экосистемой AMANITA
- **Смарт-контракты** - обеспечивают децентрализованную логику и прозрачность

## Функциональные требования

### 1. Управление продуктами (Product Management)

#### WordPress → Python микросервис
**Создание продукта**
- Отправка данных нового продукта для регистрации в блокчейне
- Включение метаданных (название, описание, категории, формы, вид)
- Передача ценовой информации с валидацией валют
- Загрузка изображений в IPFS и получение CID
- seller_address НЕ передается в теле запроса, а определяется на основе авторизации (HMAC/Bearer)
- Все дополнительные поля (sku, stock, tags и др.) могут быть помещены в meta/attributes — структура метаданных гибкая и расширяемая, что позволяет интегрировать данные из различных e-commerce систем без жесткой схемы
- Серверная модель продукта (Product) является референсом: все входящие данные должны быть приведены к этой структуре до передачи в API
- Структура продукта на сервере:
  - id: уникальный идентификатор (например, из e-commerce системы)
  - title: название
  - description: структурированное описание (Description)
  - description_cid: CID расширенного описания
  - cover_image: CID обложки (обязателен)
  - gallery: массив дополнительных изображений (опционально)
  - categories: список категорий
  - forms: список форм продукта
  - species: вид
  - prices: массив цен (каждая цена может содержать валюту, вес/объем, форму и т.д.)
  - attributes/meta: любые дополнительные поля (sku, stock, tags, custom data и др.)
- Валидация: обязательные поля — id, title, price (в составе prices), cover_image (CID)
- В случае ошибки — возвращать HTTP 4xx/5xx с описанием проблемы
- В случае успеха — возвращать HTTP 200 и массив результатов по каждому товару (id, blockchain_id, tx_hash, status)
- Логировать все входящие запросы и ошибки на стороне API
- Ограничение: только simple products, вариации не поддерживаются
- Документировать все возможные ошибки и коды ответов

**Обновление продукта**
- Изменение существующих данных продукта
- Обновление статуса активности (активен/неактивен)
- Модификация цен и доступности
- Обновление метаданных и изображений
- Все правила и структура аналогичны созданию продукта: входящие данные должны быть приведены к серверной модели продукта

**Удаление продукта**
- Деактивация продукта в блокчейне
- Очистка связанных данных
- Обновление каталога

#### Python микросервис → WordPress
**Статус операций**
- Уведомление о статусе транзакции (pending/success/error)
- Передача хэша транзакции для отслеживания
- Возврат blockchain_id продукта
- Обработка ошибок с детальным описанием

### 2. Управление заказами (Order Management)

#### WordPress → Python микросервис
**Создание заказа**
- Регистрация заказа в блокчейне
- Связывание с продуктами и их blockchain_id
- Указание покупателя и продавца
- Передача информации о платеже
- Включение адреса доставки

**Обновление статуса заказа**
- Изменение статуса (pending/processing/completed/cancelled)
- Обновление информации о платеже
- Отслеживание доставки

**Отмена заказа**
- Отмена в блокчейне
- Возврат средств (если применимо)
- Обновление инвентаря

#### Python микросервис → WordPress
**Подтверждения**
- Подтверждение создания заказа
- Уведомление об изменении статуса
- Информация о платежных транзакциях
- Обработка ошибок

### 3. Управление продавцами (Seller Management)

#### WordPress → Python микросервис
**Регистрация продавца**
- Создание аккаунта продавца в экосистеме
- Валидация wallet_address
- Настройка прав доступа
- Инициализация системы инвайтов

**Управление правами**
- Изменение статуса продавца (active/suspended)
- Обновление информации о продавце
- Управление лимитами и квотами

#### Python микросервис → WordPress
**Статус продавца**
- Подтверждение регистрации
- Информация о правах и лимитах
- Количество доступных инвайтов
- Статистика продаж

### 4. Система инвайтов (Invite System)

#### WordPress → Python микросервис
**Минтинг инвайтов**
- Создание новых инвайт-кодов для продавца
- Установка срока действия
- Назначение цели (новый клиент/партнер/опт)

**Управление инвайтами**
- Отзыв неиспользованных инвайтов
- Продление срока действия
- Изменение назначения

#### Python микросервис → WordPress
**Результаты операций**
- Передача созданных инвайт-кодов
- Статус минтинга
- Информация о сроке действия
- История использования

### 5. Валидация и проверки (Validation)

#### WordPress → Python микросервис
**Проверка инвайтов**
- Валидация инвайт-кода
- Проверка прав доступа покупателя
- Верификация статуса продавца

**Проверка продуктов**
- Валидация данных продукта
- Проверка прав продавца
- Верификация статуса в блокчейне

#### Python микросервис → WordPress
**Результаты валидации**
- Статус валидности
- Детали ошибок
- Рекомендации по исправлению

### 6. Аналитика и отчеты (Analytics)

#### WordPress → Python микросервис
**Запросы аналитики**
- Статистика продаж продавца
- Анализ продуктов
- Отчеты по заказам
- Информация о клиентах

#### Python микросервис → WordPress
**Аналитические данные**
- Агрегированная статистика
- Тренды и паттерны
- Финансовые отчеты
- Метрики экосистемы

### 7. Уведомления и события (Notifications)

#### Python микросервис → WordPress
**Системные уведомления**
- Изменения в статусе транзакций
- Обновления контрактов
- Системные события
- Ошибки и предупреждения

**Бизнес-уведомления**
- Новые заказы
- Изменения статуса заказов
- Активность продавцов
- Системные обновления

### 8. Синхронизация данных (Data Synchronization)

#### WordPress → Python микросервис
**Инициализация синхронизации**
- Первоначальная загрузка данных
- Проверка целостности
- Восстановление после сбоев

#### Python микросервис → WordPress
**Статус синхронизации**
- Прогресс синхронизации
- Ошибки и конфликты
- Рекомендации по разрешению

## Нефункциональные требования

### Производительность
- Время отклика API: < 2 секунды
- Поддержка batch операций
- Кэширование частых запросов

### Надежность
- Retry механизм для неудачных запросов
- Обработка сетевых сбоев
- Валидация данных на всех уровнях

### Безопасность
- HMAC аутентификация
- Валидация входных данных
- Защита от CSRF атак
- Логирование всех операций

### Масштабируемость
- Поддержка множественных продавцов
- Асинхронная обработка
- Очереди для тяжелых операций

## Сценарии использования

### Сценарий 1: Новый продавец регистрируется
1. WordPress создает аккаунт продавца
2. Отправляет данные в Python микросервис
3. Микросервис регистрирует в блокчейне
4. Возвращает статус и права доступа
5. WordPress обновляет интерфейс

### Сценарий 2: Продавец создает продукт
1. Продавец заполняет форму в WooCommerce
2. WordPress валидирует данные
3. Отправляет в Python микросервис
4. Микросервис загружает в IPFS и регистрирует в блокчейне
5. Возвращает статус и blockchain_id
6. WordPress отображает статус синхронизации

### Сценарий 3: Клиент делает заказ
1. Клиент оформляет заказ в WooCommerce
2. WordPress проверяет инвайт-код через API
3. Создает заказ в блокчейне
4. Получает подтверждение транзакции
5. Обновляет статус заказа

### Сценарий 4: Системная синхронизация
1. WordPress запрашивает статус всех операций
2. Python микросервис возвращает актуальные данные
3. WordPress обновляет локальные записи
4. Разрешает конфликты при необходимости

## Критерии успеха

### Функциональные
- Все операции e-commerce интегрированы с блокчейном
- Прозрачность всех транзакций
- Надежная синхронизация данных
- Полная поддержка многоуровневой системы продавцов

### Технические
- Стабильная работа API
- Быстрая обработка запросов
- Надежная обработка ошибок
- Простота интеграции и поддержки

### Бизнес
- Увеличение доверия к платформе
- Прозрачность для всех участников
- Снижение операционных рисков
- Масштабируемость бизнеса
