# Amanita WordPress Plugin Requirements

## Обзор
WordPress плагин-коннектор для интеграции WooCommerce с блокчейн экосистемой AMANITA. Плагин служит мостом между привычной e-commerce средой и децентрализованной экосистемой.

## Архитектурная роль плагина

### Основные функции
- **Коннектор** - связывает WooCommerce с Python микросервисом AMANITA
- **Синхронизатор** - обеспечивает синхронизацию данных между системами
- **Интерфейс** - предоставляет UI для управления интеграцией
- **Безопасность** - обеспечивает безопасную передачу данных

### Позиционирование в экосистеме
```
[WooCommerce Store] ↔ [Amanita WP Plugin] ↔ [Python Microservice] ↔ [Blockchain]
```

## Функциональные требования

### 1. Управление настройками интеграции

#### Конфигурация подключения
- **API Endpoint** - URL Python микросервиса
- **API Key** - ключ аутентификации для микросервиса
- **Seller Address** - адрес кошелька продавца в блокчейне
- **IPFS Provider** - настройки IPFS провайдера
- **Network** - выбор блокчейн сети (localhost/testnet/mainnet)

#### Валидация настроек
- Проверка доступности API
- Валидация формата адреса кошелька
- Тестирование подключения к IPFS
- Проверка прав доступа продавца

### 2. Интеграция с WooCommerce

#### Синхронизация продуктов
- **Автоматическая синхронизация** при создании/обновлении товара
- **Ручная синхронизация** через кнопку в админке
- **Batch синхронизация** для массовых операций
- **Откат изменений** при ошибках синхронизации

#### Метабоксы для товаров
**Отображение структуры товара в блокчейне:**
- **Blockchain ID** - уникальный идентификатор товара в смарт-контракте ProductRegistry
- **IPFS CID** - ссылка на JSON-метаданные товара в IPFS
- **Active Status** - статус активности товара в блокчейне (true/false)

**Статус синхронизации:**
- **Sync Status** - статус синхронизации (pending/success/error)
- **Transaction Hash** - хэш последней транзакции в блокчейне
- **Last Sync** - время последней синхронизации
- **Error Details** - детали ошибки (если есть)

**Кнопки управления:**
- **Sync Now** - принудительная синхронизация с блокчейном
- **Retry** - повторная попытка при ошибке
- **View on Blockchain** - просмотр в блокчейн эксплорере
- **View IPFS** - просмотр метаданных в IPFS

**Принцип Source of Truth:**
- **WooCommerce является источником истины** для создания и обновления данных
- Все изменения товаров происходят через интерфейс WooCommerce
- При рассинхронизации данных приоритет отдается данным из WooCommerce
- Блокчейн слой обновляется на основе данных WooCommerce
- Продавцы не получают данные о своих продуктах из блокчейна, а работают только через WooCommerce

#### Синхронизация заказов
- **Автоматическая регистрация** новых заказов
- **Обновление статусов** заказов
- **Отслеживание платежей** в блокчейне
- **Интеграция с инвайт-системой**

### 3. Управление продавцами

#### Регистрация продавцов
- **Форма регистрации** в админке WordPress
- **Валидация wallet address**
- **Настройка прав доступа**
- **Инициализация инвайт-системы**

#### Управление правами
- **Роли продавцов** (basic/premium/admin)
- **Лимиты продуктов** и заказов
- **Управление инвайтами**
- **Статистика активности**

### 3.1. Гибкая выдача инвайтов покупателям (Single Seller)

#### Принципы:
- Селлер может генерировать инвайты неограниченно
- Инвайты выдаются по заданным правилам, которые настраиваются в админке
- Все правила применяются к существующим покупателям WooCommerce

#### Варианты правил выдачи инвайтов:
1. **Покупка в определённый период**
   - Если клиент совершил покупку в заданном диапазоне дат — получает инвайт
2. **Покупка на сумму выше порога**
   - Если сумма заказа >= X — клиент получает инвайт
3. **Покупка определённого количества товаров**
   - Если количество единиц в заказе >= Y — клиент получает инвайт
4. **Покупка определённого товара или категории**
   - Если в заказе есть товар из выбранной категории/конкретный товар — инвайт
5. **Повторная покупка**
   - Если клиент совершил N покупок за всё время — получает инвайт
6. **Ручная выдача**
   - Админ вручную выбирает покупателей и выдает им инвайты (генерируется инвайт и отправляется емейл пользователю в специальном шаблоне)

#### Функционал в админке продавца:
- Раздел "Правила выдачи инвайтов":
  - Список активных правил (с возможностью включения/выключения)
  - Форма добавления нового правила (тип, параметры, период действия)
  - История срабатываний правил (кто и когда получил инвайт, по какому правилу)

Функционал пользователя выносится в браузерный кошелек и будет прописан отдельно.

### 4. Аналитика и отчеты

#### Дашборд продавца-амбассадора
- **Статистика социального майнинга** - сколько $AMANITA намайнил текущий селлер (через то что его покупатели приводят людей)
- **Эффективность токенов** - сколько $AMANITA было принято селлером для обеспечения скидки
- **История майнинга** - детальная статистика по каждому приглашенному

### 5. Уведомления и события

#### Бизнес-уведомления
- **Новые заказы** и их статусы
- **Активность приглашенных пользователей** - кто активировал инвайт
- **Начисление токенов** - уведомления о заработанных $AMANITA
- **Использование скидок** - когда приглашенные используют токены
- **Системные события** экосистемы AMANITA

#### Интеграция с Amanita кошельком (webapp)
- **Встраивание  в чекаут** кошелька (можно делать iframe для начала) для новых пользователей экосистемы Amanita. Нужно повторить процесс который уже реализован в боте при регистрации.

### 8. Безопасность и валидация

#### Аутентификация и авторизация
- **HMAC подписи** для API запросов
- **Проверка прав доступа** пользователей
- **Безопасное хранение** API ключей
- **Логирование** всех операций

#### Валидация данных
- **Проверка форматов** данных
- **Валидация цен** и валют
- **Проверка изображений** и метаданных
- **Санитизация** входных данных

## Технические требования

### Совместимость
- **WordPress** 5.0+
- **WooCommerce** 3.0+
- **PHP** 7.4+
- **MySQL** 5.7+

### Производительность
- **Время отклика** < 3 секунды для UI операций
- **Фоновая обработка** через Action Scheduler
- **Кэширование** частых запросов
- **Оптимизация** базы данных

### Надежность
- **Retry механизм** для неудачных API вызовов
- **Обработка сетевых сбоев**
- **Восстановление** после ошибок
- **Резервное копирование** настроек

### Масштабируемость
- **Поддержка множественных** продавцов
- **Асинхронная обработка** тяжелых операций
- **Очереди** для batch операций
- **Горизонтальное масштабирование**

## Пользовательский интерфейс

### Админ-панель

#### 1. Главная страница
- Статус интеграции с Python микросервисом (OK/Ошибка)
- Баланс $AMANITA (намайнено, принято для скидок)
- Последние события (синхронизация, ошибки, начисления)
- Краткая справка по работе с инвайтами и кошельком

#### 2. Настройки интеграции
- API Endpoint, API Key, Seller Wallet Address
- Кнопка проверки подключения
- Статус подключения и журнал ошибок

#### 3. Инвайты и правила выдачи
- Раздел "Правила выдачи инвайтов":
  - Список активных правил (по периоду, сумме, количеству, повторным покупкам, ручная выдача)
  - Включение/выключение, редактирование, удаление правил
  - Форма добавления нового правила (тип, параметры, период действия)
  - История срабатываний правил (кто и когда получил инвайт, по какому правилу)
- Ручная выдача:
  - Выбор покупателя, генерация инвайта, отправка email по шаблону
- В карточке покупателя:
  - Список выданных инвайтов, история покупок, по которым был выдан инвайт

#### 4. Аналитика и отчёты
- Дашборд продавца-амбассадора:
  - Сколько $AMANITA намайнил текущий селлер (через то, что его покупатели приводят людей)
  - Сколько $AMANITA было принято селлером для обеспечения скидки
  - История майнинга (детализация по каждому приглашённому)
- Экспорт:
  - CSV-отчёты по инвайтам, майнингу, использованию токенов

#### 5. Уведомления
- Важные события через admin notices (ошибки, начисления, истечение инвайтов)
- Email-уведомления по критическим событиям (опционально)

#### 6. Интеграция с WooCommerce
- Метабоксы в товарах и заказах (статус синхронизации, Blockchain ID, IPFS CID, информация о приглашённом клиенте)
- В профиле пользователя — только адрес кошелька и статистика по инвайтам

#### 7. Интеграция с Amanita кошельком (webapp)
- Встраивание кошелька в чекаут (iframe или редирект)
- Повторение процесса регистрации из Telegram-бота
- Вся работа с токенами и пользовательским функционалом — только через webapp-кошелёк

#### 8. Безопасность
- Хранение ключей только в базе WP с шифрованием
- Проверка прав доступа к настройкам (только админ)
- Логирование действий (выдача инвайтов, ошибки интеграции)

**MVP:**
- Только необходимый минимум для single seller: интеграция, гибкие правила инвайтов, аналитика, базовые уведомления, интеграция с кошельком через webapp.
- Нет сложных ролей, нет управления продуктами/заказами вне WooCommerce, нет пользовательских страниц — только админка для продавца.

### Метабоксы
- **В карточке товара** - статус синхронизации с блокчейном
- **В карточке заказа** - статус в блокчейне и информация о приглашенном клиенте
- **В профиле пользователя** - права продавца и статистика социального майнинга
- **В карточке клиента** - информация о том, кто пригласил и статус в экосистеме AMANITA

### Уведомления
- **Admin notices** для важных событий
- **Email уведомления** для критических ошибок
- **In-app уведомления** в админке

## Интеграционные требования

### WooCommerce хуки
- `woocommerce_new_product` - создание товара
- `woocommerce_update_product` - обновление товара
- `woocommerce_delete_product` - удаление товара
- `woocommerce_new_order` - создание заказа
- `woocommerce_order_status_changed` - изменение статуса заказа
- `woocommerce_checkout_process` - валидация инвайт-кода при оформлении
- `woocommerce_checkout_order_processed` - создание Amanita кошелька после заказа
- `woocommerce_order_status_completed` - активация социального майнинга

### Пользовательский опыт для клиентов

#### Процесс приглашения в экосистему
- **Естественная интеграция** - предложение присоединиться к AMANITA при оформлении заказа
- **Простота активации** - один клик для создания кошелька через инвайт-код
- **Прозрачность** - четкое объяснение преимуществ участия в экосистеме
- **Безопасность** - некастодиальный кошелек с полным контролем пользователя

#### Управление токенами AMANITA
- **Просмотр баланса** - текущее количество $AMANITA
- **История операций** - все транзакции в блокчейне
- **Использование скидок** - применение токенов к покупкам
- **Приглашение друзей** - получение собственных 12 инвайт-кодов

#### Интеграция с магазином
- **Автоматические скидки** - применение токенов при оформлении заказа
- **Уведомления** - информация о начислении и использовании токенов
- **Персонализация** - рекомендации на основе активности в экосистеме

### WordPress хуки
- `admin_init` - инициализация админки
- `wp_ajax_*` - AJAX обработчики
- `admin_enqueue_scripts` - подключение скриптов
- `admin_menu` - регистрация меню

### Action Scheduler
- `amanita_sync_product` - синхронизация товара
- `amanita_sync_order` - синхронизация заказа
- `amanita_batch_sync` - массовая синхронизация
- `amanita_cleanup` - очистка временных данных

## Требования к безопасности

### Хранение данных
- **Шифрование** API ключей
- **Безопасное хранение** wallet addresses
- **Очистка** временных данных
- **Логирование** всех операций

### API безопасность
- **HMAC аутентификация** для всех запросов
- **Rate limiting** для предотвращения спама
- **Валидация** всех входных данных
- **CSRF защита** для форм

### Права доступа
- **Capability checks** для всех операций
- **Nonce валидация** для форм
- **Роли и права** пользователей
- **Аудит** действий пользователей

## Требования к локализации

### Поддержка языков
- **Русский** (основной)
- **Английский**
- **Испанский**
- **Немецкий**
- **Французский**

### Файлы локализации
- **amanita.pot** - шаблон переводов
- **amanita-ru_RU.po/.mo** - русские переводы
- **amanita-en_US.po/.mo** - английские переводы
- **Поддержка RTL** языков

## Требования к тестированию

### Unit тесты
- **Тестирование** всех основных классов
- **Моки** для внешних зависимостей
- **Покрытие кода** > 80%
- **Автоматизация** тестов

### Интеграционные тесты
- **Тестирование** API интеграции
- **Проверка** синхронизации данных
- **Тестирование** UI компонентов
- **End-to-end** сценарии

### Тестовые данные
- **Фикстуры** для тестирования
- **Мок-сервер** для API
- **Тестовые** кошельки и контракты
- **Сценарии** использования

## Требования к развертыванию

### Установка
- **Автоматическая** установка через WordPress
- **Проверка** зависимостей
- **Миграция** данных при обновлении
- **Откат** при ошибках

### Обновления
- **Автоматические** обновления
- **Миграция** настроек
- **Совместимость** с предыдущими версиями
- **Уведомления** об обновлениях

### Удаление
- **Полная очистка** данных
- **Удаление** настроек
- **Отмена** Action Scheduler задач
- **Восстановление** WooCommerce

## Критерии приемки

### Функциональные
- ✅ Все операции e-commerce синхронизированы с блокчейном
- ✅ Прозрачность всех транзакций для продавцов
- ✅ Надежная работа системы инвайтов
- ✅ Полная интеграция с WooCommerce

### Технические
- ✅ Стабильная работа плагина
- ✅ Быстрая обработка операций
- ✅ Надежная обработка ошибок
- ✅ Простота установки и настройки

### Пользовательские
- ✅ Интуитивный интерфейс
- ✅ Понятные уведомления
- ✅ Подробная документация
- ✅ Поддержка пользователей

### Бизнес
- ✅ Увеличение доверия к платформе
- ✅ Прозрачность для всех участников
- ✅ Снижение операционных рисков
- ✅ Масштабируемость бизнеса
