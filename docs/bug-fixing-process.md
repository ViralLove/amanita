# Процесс изоляции и воспроизведения ошибки с транзакциями в InviteNFT

## 1. Анализ исходной ошибки в тесте онбординга

- В тесте `test_onboarding_flow` возникала ошибка при ожидании receipt после вызова `transact_contract_function`:
  ```
  TypeError: Exactly one of the passed values can be specified. Instead, values were: (None,), {'hexstr': None}
  ```
- Логирование показало, что метод возвращает не строку-хэш транзакции, а объект (например, SignedTransaction) или None.
- Это приводило к сбою в web3 при вызове `wait_for_transaction_receipt`.

## 2. Формулировка гипотезы

- Причина ошибки — некорректный тип возвращаемого значения из `transact_contract_function`.
- Ожидалось: строка-хэш транзакции.
- Фактически: объект или None.

## 3. Изоляция проблемы в отдельном тесте

- Создан отдельный файл `test_alarm_mode.py` для диагностики изолированных ошибок.
- Реализован тест `test_transact_contract_function_receipt_error`, который:
  - Вызывает реальный метод `transact_contract_function` с валидными аргументами.
  - Сразу после этого вызывает `web3.eth.wait_for_transaction_receipt(tx_hash)`.
  - Добавлено подробное логирование:
    - Аргументы вызова
    - Тип и содержимое возвращаемого значения (tx_hash)
    - Попытка получить receipt и обработка исключения
- Тест воспроизводит ошибку, если возвращается не строка.

## 4. Результат изоляции

- При запуске теста ошибка воспроизводится ровно в той же точке, что и в боевом тесте:
  ```
  TypeError: Exactly one of the passed values can be specified. Instead, values were: (None,), {'hexstr': None}
  ```
- Логи показывают, что возвращаемое значение не соответствует ожиданиям.
- Таким образом, проблема полностью локализована и воспроизводится в изолированной среде.

## 5. Выводы и рекомендации

- Для устранения ошибки необходимо, чтобы `transact_contract_function` всегда возвращал строку-хэш отправленной транзакции.
- Изолированный тест с подробным логированием позволяет быстро проверить исправление и предотвратить регрессии в будущем.

## 6. Подробный анализ процесса поиска и исправления

### 6.1. Диагностика и локализация
- После изоляции ошибки был добавлен максимально подробный лог на каждом этапе выполнения метода transact_contract_function:
  - Логировались: сборка транзакции, подписание, отправка, возврат, типы объектов.
  - Это позволило увидеть, что ошибка возникает не на этапе подписания, а при попытке обращения к атрибуту `rawTransaction` у объекта SignedTransaction.
- Лог показал, что в web3.py 7.x+ нужный атрибут называется `raw_transaction` (с подчёркиванием), а не `rawTransaction` (camelCase).

### 6.2. Проверка гипотезы
- Гипотеза: ошибка связана с несовместимостью версий web3.py и использованием устаревшего имени атрибута.
- Для проверки была добавлена явная печать содержимого signed_txn и попытка получить оба варианта атрибута.
- Лог подтвердил: `signed_txn.rawTransaction` отсутствует, а `signed_txn.raw_transaction` содержит нужные данные.

### 6.3. Исправление
- В коде метода transact_contract_function все обращения к `signed_txn.rawTransaction` были заменены на `signed_txn.raw_transaction`.
- Лишние логи, связанные с устаревшим атрибутом, были удалены для чистоты.

### 6.4. Финальное тестирование
- После исправления был повторно запущен изолированный тест.
- Тест прошёл успешно: транзакция отправилась, функция вернула строку-хэш, ошибок типа не возникло.
- Логи показали корректную работу всех этапов: сборка, подписание, отправка, возврат.

## 7. Итог
- Проблема была полностью локализована и устранена благодаря поэтапному логированию и изоляции.
- Метод transact_contract_function теперь всегда возвращает строку-хэш транзакции, что гарантирует корректную работу всех последующих операций с web3.
- Такой подход позволяет быстро выявлять и устранять ошибки, связанные с несовместимостью библиотек и типами данных в интеграционных слоях.
